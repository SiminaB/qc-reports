---
title: "CPTAC Study Consistency Report"
author: "Simina Boca, Shaojun Tang, Yi Bai, Jiahao Huang, Nathan Edwards"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
params:
  qcmetricsfile: inputfilename.tsv
  summaryfile: inputfilename.tsv
  peptidefile: inputfilename.tsv
  quantfile: inputfilename.tsv
  mayufile: inputfilename.tsv
  format: html_document
  debug: true
  dochecks: false
output:
  html_document:
    number_sections: yes
    smooth_scroll: no
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
always_allow_html: yes
---

<!--Resize the main-container to spread the title-->
<style>
body .main-container {
max-width: 2030px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r, warning=FALSE, include=FALSE}
library(ggplot2)
library(reshape2)
library(knitr)
library(kableExtra)
library(RColorBrewer) ## generate palette
library(grid)
library(pander) ## this package is used ot convert the .md file into PDF
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(gridExtra)) ## to show the plots side by side 
suppressPackageStartupMessages(library(plotly))
options(warn = -1,scipen=1000000)

source("functions.R")
source("make_annotation_titles.R")
```

```{r}
# this allows the kable function work in html format to make pretty tables
#but will not work in the PDF files, remember to remove it if generating PDF files
#also removing the lines with kable in the code chunks related
if (params$format != 'pdf_document') {
  options(knitr.table.format = "html")  
}
```

```{r,include=FALSE}
##Read in metrics for individual analytical samples and fractions and relabel some columns

mylog <- function(s) {
  if (params$debug) {
    capture.output(cat(c(deparse(substitute(s)),"\n")),file='debug.log',append=TRUE)
    capture.output(s,file='debug.log',append=TRUE)
    capture.output(cat("\n"),file='debug.log',append=TRUE)
  }
}
file.remove('debug.log')

# mylog(params)

QCmetrics_file <- params$qcmetricsfile
Summary_file <- params$summaryfile
Peptide_file <- params$peptidefile
tmt10_file <- params$quantfile
mayu_file <- params$mayufile

QCmetrics <- read.table(QCmetrics_file, header=TRUE, sep="\t", quote = "")
SUmetrics <- read.table(Summary_file,   header=TRUE, sep="\t", quote = "")
PEmetrics <- read.table(Peptide_file,   header=TRUE, sep="\t", quote = "")
MYmetrics <- read.table(mayu_file,   sep="\t", quote = "")

##rename a lot of the columns to make it easier later "fractionNum" to "Fraction"
QCmetrics <- rename(QCmetrics, 
                    Fraction=fractionNum, ##fractionNum -> Fraction
                    PrecursorIntensityALL.0 = minPrecursorIntensity_ALL, ##intensity ALL
                    PrecursorIntensityALL.5 = PrecursorIntensity5perc_ALL,
                    PrecursorIntensityALL.25 = PrecursorIntensity25perc_ALL,
                    PrecursorIntensityALL.50 = PrecursorIntensity50perc_ALL,
                    PrecursorIntensityALL.75 = PrecursorIntensity75perc_ALL,
                    PrecursorIntensityALL.95 = PrecursorIntensity95perc_ALL,
                    PrecursorIntensityALL.100 = maxPrecursorIntensity_ALL,
                    PrecursorIntensityID.0 = minPrecursorIntensity_ID,
                    PrecursorIntensityID.5 = PrecursorIntensity5perc_ID, ##intensity ID
                    PrecursorIntensityID.25 = PrecursorIntensity25perc_ID,
                    PrecursorIntensityID.50 = PrecursorIntensity50perc_ID,
                    PrecursorIntensityID.75 = PrecursorIntensity75perc_ID,
                    PrecursorIntensityID.95 = PrecursorIntensity95perc_ID,
                    PrecursorIntensityID.100 = maxPrecursorIntensity_ID,
                    PrecursorMZALL.0 = minPrecursorMZ_ALL, ##MZ ALL
                    PrecursorMZALL.5 = PrecursorMZ5perc_ALL, 
                    PrecursorMZALL.25 = PrecursorMZ25perc_ALL,
                    PrecursorMZALL.50 = PrecursorMZ50perc_ALL,
                    PrecursorMZALL.75 = PrecursorMZ75perc_ALL,
                    PrecursorMZALL.95 = PrecursorMZ95perc_ALL,
                    PrecursorMZALL.100 = maxPrecursorMZ_ALL,
                    PrecursorMZID.0 = minPrecursorMZ_ID, ##MZ ID
                    PrecursorMZID.5 = PrecursorMZ5perc_ID,
                    PrecursorMZID.25 = PrecursorMZ25perc_ID,
                    PrecursorMZID.50 = PrecursorMZ50perc_ID,
                    PrecursorMZID.75 = PrecursorMZ75perc_ID,
                    PrecursorMZID.95 = PrecursorMZ95perc_ID,
                    PrecursorMZID.100 = maxPrecursorMZ_ID,
                    PrecursorMWALL.0 = minPrecursorMW_ALL, ##MW ALL
                    PrecursorMWALL.5 = PrecursorMW5perc_ALL,
                    PrecursorMWALL.25 = PrecursorMW25perc_ALL,
                    PrecursorMWALL.50 = PrecursorMW50perc_ALL,
                    PrecursorMWALL.75 = PrecursorMW75perc_ALL,
                    PrecursorMWALL.95 = PrecursorMW95perc_ALL,
                    PrecursorMWALL.100 = maxPrecursorMW_ALL,
                    PrecursorMWID.0 = minPrecursorMW_ID, ##MW ID
                    PrecursorMWID.5 = PrecursorMW5perc_ID,
                    PrecursorMWID.25 = PrecursorMW25perc_ID,
                    PrecursorMWID.50 = PrecursorMW50perc_ID,
                    PrecursorMWID.75 = PrecursorMW75perc_ID,
                    PrecursorMWID.95 = PrecursorMW95perc_ID,
                    PrecursorMWID.100 = maxPrecursorMW_ID,
                    MS2perMS1ALL.0 = minMS2perMS1_ALL, ##MS2 per MS1 ALL
                    MS2perMS1ALL.5 = MS2perMS1_5perc_ALL,
                    MS2perMS1ALL.25 = MS2perMS1_25perc_ALL,
                    MS2perMS1ALL.50 = MS2perMS1_50perc_ALL,
                    MS2perMS1ALL.75 = MS2perMS1_75perc_ALL,
                    MS2perMS1ALL.95 = MS2perMS1_95perc_ALL,
                    MS2perMS1ALL.100 = maxMS2perMS1_ALL,
                    MS2perMS1ID.0 = minMS2perMS1_ID, ##MS2 per MS1 ID
                    MS2perMS1ID.5 = MS2perMS1_5perc_ID,
                    MS2perMS1ID.25 = MS2perMS1_25perc_ID,
                    MS2perMS1ID.50 = MS2perMS1_50perc_ID,
                    MS2perMS1ID.75 = MS2perMS1_75perc_ID,
                    MS2perMS1ID.95 = MS2perMS1_95perc_ID,
                    MS2perMS1ID.100 = maxMS2perMS1_ID,
                    MS2chargeALL.1 = MS2Charge1_ALL, ##MS2 charge ALL
                    MS2chargeALL.2 = MS2Charge2_ALL,
                    MS2chargeALL.3 = MS2Charge3_ALL,
                    MS2chargeALL.4 = MS2Charge4_ALL,
                    MS2chargeALL.5andhigher = MS2Charge5_ALL,
                    MS2chargeID.1 = MS2Charge1_ID, ##MS2 charge ID
                    MS2chargeID.2 = MS2Charge2_ID,
                    MS2chargeID.3 = MS2Charge3_ID,
                    MS2chargeID.4 = MS2Charge4_ID,
                    MS2chargeID.5andhigher = MS2Charge5_ID, 
                    PeptideRd.0 = minPeptideRedundancy, ##peptide redundacies
                    PeptideRd.5 = PeptideRedundancy5perc,
                    PeptideRd.25 = PeptideRedundancy25perc,
                    PeptideRd.50 = PeptideRedundancy50perc,
                    PeptideRd.75 = PeptideRedundancy75perc,
                    PeptideRd.95 = PeptideRedundancy95perc,
                    PeptideRd.100 = maxPeptideRedundancy,
                    RetentionTimeALL.0 = minRetentionTime_ALL, ##retention time ALL
                    RetentionTimeALL.5 = RetentionTime5perc_ALL,
                    RetentionTimeALL.25 = RetentionTime25perc_ALL,
                    RetentionTimeALL.50 = RetentionTime50perc_ALL,
                    RetentionTimeALL.75 = RetentionTime75perc_ALL,
                    RetentionTimeALL.95 = RetentionTime95perc_ALL,
                    RetentionTimeALL.100 = maxRetentionTime_ALL,
                    RetentionTimeID.0 = minRetentionTime_ID, ##retention time ID
                    RetentionTimeID.5 = RetentionTime5perc_ID,
                    RetentionTimeID.25 = RetentionTime25perc_ID,
                    RetentionTimeID.50 = RetentionTime50perc_ID,
                    RetentionTimeID.75 = RetentionTime75perc_ID,
                    RetentionTimeID.95 = RetentionTime95perc_ID,
                    RetentionTimeID.100 = maxRetentionTime_ID)

QCmetrics$analyticalBasenameLabel <- QCmetrics$analyticalBasename
QCmetrics$analyticalBasenameFactor <- factor(QCmetrics$analyticalBasenameLabel)
QCmetrics$analyticalBasenameIndex <- as.numeric(QCmetrics$analyticalBasenameFactor)
QCmetrics$analyticalBasename <- QCmetrics$analyticalBasenameIndex

```

```{r}
# if these are left as numbers, the color scale is messed up. Why?
# QCmetrics$analyticalBasename <- as.character(QCmetrics$analyticalBasename)
# This will ensure proper sort order (at least until 100 analytical samples)
QCmetrics$analyticalBasename <- sprintf("%02d",QCmetrics$analyticalBasename)

##add some new columns to QCmetrics (same as other columns, but useful for tooltip!)
QCmetrics$`Analytical sample` <- QCmetrics$analyticalBasename 

# summary(QCmetrics$analyticalBasename)
# summary(QCmetrics$analyticalBasenameIndex)

##get total number of spectra per analytical sample
numofMS2_ALL_per_AS <- tapply(QCmetrics$numofMS2_ALL, 
                              INDEX=QCmetrics$analyticalBasename, 
                              FUN=sum)
numofMS2_ID_per_AS <- tapply(QCmetrics$numofMS2_ID, 
                             INDEX=QCmetrics$analyticalBasename, 
                             FUN=sum)
identical(names(numofMS2_ALL_per_AS), names(numofMS2_ID_per_AS))

QCmetrics_AS <- data.frame(analyticalBasename=names(numofMS2_ID_per_AS),
                           numofMS2_ALL_per_AS=numofMS2_ALL_per_AS,
                           numofMS2_ID_per_AS=numofMS2_ID_per_AS)
QCmetrics_AS$`Analytical sample` <- QCmetrics_AS$analyticalBasename
```

```{r,include=FALSE}
## Get the fractions, give a number to the non-number fractions
## There must be a more straightfoward way to do this!!!!
QCmetrics$FractionString <- as.character(QCmetrics$Fraction)
fracnums <- as.numeric(QCmetrics$FractionString)
fracisnum <- !is.na(fracnums)
fraclabs <- data.frame(ufraclab=unique(QCmetrics$Fraction[order(fracnums,QCmetrics$FractionString)]))
fraclabs$ufraclab<-as.character(fraclabs$ufraclab)
ufracnums <- as.numeric(fraclabs$ufraclab)
ufracisnum <- !is.na(ufracnums)
fraclabs$fracindex <- 1:length(fraclabs$ufraclab)
if (sum(ufracisnum) == 0) {
    maxfracnum <- 0
} else {
    maxfracnum <- max(ufracnums[ufracisnum])
}
fraclabs$fracnum <- ufracnums
fraclabs$fracnum[!ufracisnum] <- (maxfracnum+1):(maxfracnum+(sum(!ufracisnum)))
QCmetrics <- merge(QCmetrics,fraclabs,by.x='Fraction',by.y='ufraclab')
QCmetrics$FractionIndex <- QCmetrics$fracindex
QCmetrics$fracindex <- NULL
QCmetrics$FractionNumber <- QCmetrics$fracnum
QCmetrics$fracnum <- NULL

mylog(fraclabs)
## Now QCmetrics has Fraction (factor, probably), FractionString, FractionIndex, and FractionNumber
## Single alpha letter fractions come after all numbers.
QCmetrics$Fraction <- QCmetrics$FractionString
```

```{r,include=FALSE}
##need to separate out the fractions if they are all equal to NA (this means they have not been pulled out before)
if(sum(!is.na(QCmetrics$Fraction)) == 0)
{
  analyticalBasenameSplit <- strsplit(as.character(QCmetrics$analyticalBasename),"_Fr_")
  QCmetrics$analyticalBasename <- sapply(analyticalBasenameSplit, function(x){x[1]})
  QCmetrics$Fraction <- as.numeric(sapply(analyticalBasenameSplit, function(x){x[2]}))
  unique(QCmetrics$Fraction)
  QCmetrics$Fraction[is.na(QCmetrics$Fraction)] <- 25
}

##Get the fractions (check they are 1-24):
##Ugh - should use a better marker for "A" - how about 1000? or -1? or #unique fraction values? 
##QCmetrics file will have an A in the fraction position, not NA, from now on. Handle this explicitly. 

sort(unique(QCmetrics$Fraction))
length(unique(QCmetrics$Fraction))

QCmetrics$Fraction[is.na(QCmetrics$Fraction)] <- 25
```

```{r, include=FALSE}
##Get the number of unique analytical samples
analyticalSamples <- unique(QCmetrics$analyticalBasename)
length(analyticalSamples)

##Make sure the labels in spectrumBasename are unique
length(unique(QCmetrics$spectrumBasename))

##Get the number of unique fractions
fractions <- unique(QCmetrics$Fraction)
```

```{r,include=FALSE}
charge0avail <- FALSE
if ("MS2Charge0_ALL" %in% colnames(QCmetrics)) {
    QCmetrics <- rename(QCmetrics,
                        MS2chargeALL.0 = MS2Charge0_ALL)
    charge0avail <- TRUE
}

##Create data frame melting the precursor intensities
QCmetricsLongPrecInt_ALL <- 
  melt_by_fraction(QCmetrics,
                   cols=grep("^(analyticalBasename|Fraction|PrecursorIntensityALL\\.\\d+)$",
                             colnames(QCmetrics)),
                   "PrecursorIntensityALL")

##Create data frame melting the precursor MZ values
QCmetricsLongPrecMZ_ALL <- 
  melt_by_fraction(QCmetrics, 
                   cols=
                     grep("^(analyticalBasename|Fraction|PrecursorMZALL\\.\\d+)$",
                          colnames(QCmetrics)),
                   "PrecursorMZALL")

##Create data frame melting the precursor MW values
QCmetricsLongPrecMW_ALL <- 
  melt_by_fraction(QCmetrics, 
                   cols=grep("^(analyticalBasename|Fraction|PrecursorMWALL\\.\\d+)$",
                             colnames(QCmetrics)),
                   "PrecursorMWALL") 

##Create data frame melting the MS2perMS values
QCmetricsLongMS2perMS_ALL <- 
  melt_by_fraction(QCmetrics, 
                   cols=grep("^(analyticalBasename|Fraction|MS2perMS1ALL\\.\\d+)$",
                                                  colnames(QCmetrics)),
                   "MS2perMS1ALL")  

##Create data frame melting MS2 charge ratio
QCmetricsLongMS2Charge_ALL <- 
  melt_by_fraction(QCmetrics, 
                   cols=grep("^(analyticalBasename|Fraction|MS2chargeALL\\.\\d+[a-z]*)$",
                             colnames(QCmetrics)),
                   split="MS2ChargeState",
                   "MS2chargeALL")  

QCmetricsLongMS2Charge_ALL$MS2chargeALL <- NULL
totalMS2_ALL = sum(QCmetricsLongMS2Charge_ALL$value)
QCmetricsLongMS2Charge_ALL$Chargeratio<- c(QCmetricsLongMS2Charge_ALL$value/totalMS2_ALL)

# Create data frame melting Peptie Redundancy (Jiahao)
QCmetricsPeptideRd <- 
  melt_by_fraction(QCmetrics,
                   cols=grep("^(analyticalBasename|Fraction|PeptideRd\\.\\d+)$",
                             colnames(QCmetrics)),
                   "PeptideRd")
  
# Create data frame melting Retention Time All
QCmetricsPeptideRT_ALL <- 
  melt_by_fraction(QCmetrics,
                   cols=grep("^(analyticalBasename|Fraction|RetentionTimeALL\\.\\d+)$",
                             colnames(QCmetrics)),
                   "RetentionTimeALL") 

# Create dataframe for different charge state
# create the label

if (charge0avail) {
  chargestate <- c("N/A","+1","+2", "+3","+4",">= +5")
} else {
  chargestate <- c("+1","+2", "+3","+4",">= +5")
}

#calculate the ratio for each of the charge state   
chargestateratio_ALL <- tapply(QCmetricsLongMS2Charge_ALL$Chargeratio,
                               INDEX = QCmetricsLongMS2Charge_ALL$MS2ChargeState,
                               FUN = sum)
  
#generate the data frame contains the cahrge ratio
Chargeratio_ALL <- data.frame(chargestate, chargestateratio_ALL)
```

```{r,include=FALSE}
if ("MS2Charge0_ID" %in% colnames(QCmetrics)) {
    QCmetrics <- rename(QCmetrics,
                        MS2chargeID.0 = MS2Charge0_ID)
}

##Create data frame melting the precursor intensities
QCmetricsLongPrecInt_ID <- 
  melt_by_fraction(QCmetrics,
                   cols=grep("^(analyticalBasename|Fraction|PrecursorIntensityID\\.\\d+)$",
                             colnames(QCmetrics)),
                   "PrecursorIntensityID") 

##Create data frame melting the precursor MZ values
QCmetricsLongPrecMZ_ID <- 
  melt_by_fraction(QCmetrics, 
                   cols=grep("^(analyticalBasename|Fraction|PrecursorMZID\\.\\d+)$",
                             colnames(QCmetrics)),
                   "PrecursorMZID") 

##Create data frame melting the precursor MW values
QCmetricsLongPrecMW_ID <- 
  melt_by_fraction(QCmetrics,
                   cols=grep("^(analyticalBasename|Fraction|PrecursorMWID\\.\\d+)$",
                             colnames(QCmetrics)),
                   "PrecursorMWID") 

##Create data frame melting the MS2perMS values
QCmetricsLongMS2perMS_ID <- 
  melt_by_fraction(QCmetrics, 
                   cols=grep("^(analyticalBasename|Fraction|MS2perMS1ID\\.\\d+)$",
                             colnames(QCmetrics)),
                   "MS2perMS1") 

##Create data frame melting MS2 charge ratio
QCmetricsLongMS2Charge_ID <- 
  melt_by_fraction(QCmetrics,
                   cols=grep("^(analyticalBasename|Fraction|MS2chargeID\\.\\d[a-z]*)$",
                             colnames(QCmetrics)),
                   "MS2chargeID",
                   split="MS2ChargeState")  
totalMS2_ID = sum(QCmetricsLongMS2Charge_ID$value)
QCmetricsLongMS2Charge_ID$Chargeratio<- c(QCmetricsLongMS2Charge_ID$value/totalMS2_ID)

# calculate the values for charge distribution for different charge state 
chargestateratio_ID <- tapply(QCmetricsLongMS2Charge_ID$Chargeratio,
                              INDEX = QCmetricsLongMS2Charge_ID$MS2ChargeState,
                              FUN = sum)

#generate the data frame contains the cahrge ratio (Jiahao)
Chargeratio_ID <- data.frame(chargestate, chargestateratio_ID)
Chargeratio_ID$`Proportion` <- round((Chargeratio_ID$chargestateratio_ID)*100,2)
Chargeratio_ALL$`Proportion` <- round((Chargeratio_ALL$chargestateratio_ALL)*100,2)

summary(Chargeratio_ALL)
summary(Chargeratio_ID)

# Create data frame melting Retention Time ID (Jiahao)
QCmetricsPeptideRT_ID <- 
  melt_by_fraction(QCmetrics,
                   cols=grep("^(analyticalBasename|Fraction|RetentionTimeID\\.\\d+)$",
                             colnames(QCmetrics)),
                   "RetentionTimeID") 
```

```{r, include=FALSE}
# Cleaning the Summary data
col_selection <- grepl(".Unshared.Peptides$", names(SUmetrics))

Spectral_table <- SUmetrics[ , col_selection, drop=FALSE ]

id_protein <- Spectral_table[ , , drop=FALSE ] >= 2

cum_id_protein <- id_protein
all_id_protein <- id_protein
if (ncol(cum_id_protein)>1) {
  for(i in 2:ncol(cum_id_protein)) {
    cum_id_protein[,i] = (cum_id_protein[,i]|cum_id_protein[,(i-1)])
    all_id_protein[,i] = (all_id_protein[,i]&all_id_protein[,(i-1)])
  }
}

id_protein <- data.frame(colSums(id_protein))
cum_id_protein <- data.frame(colSums(cum_id_protein))
all_id_protein <- data.frame(colSums(all_id_protein))
colnames(id_protein) <- "ProteinCounts"
colnames(cum_id_protein) <- "ProteinCounts"
colnames(all_id_protein) <- "ProteinCounts"
id_protein$analyticalBasename <- rownames(id_protein)

id_protein$analyticalBasenameLabel <- id_protein$analyticalBasename
id_protein$analyticalBasenameFactor <- factor(id_protein$analyticalBasenameLabel)
id_protein$analyticalBasenameIndex <- as.numeric(id_protein$analyticalBasenameFactor)
id_protein$analyticalBasename <- id_protein$analyticalBasenameIndex
 
# id_protein$analyticalBasename <- as.character(id_protein$analyticalBasename)
id_protein$analyticalBasename <- sprintf("%02d",id_protein$analyticalBasename)
id_protein$`Analytical sample` <- id_protein$analyticalBasename
cum_id_protein$analyticalBasename <- id_protein$analyticalBasename
cum_id_protein$`Analytical sample` <- id_protein$`Analytical sample`
all_id_protein$analyticalBasename <- id_protein$analyticalBasename
all_id_protein$`Analytical sample` <- id_protein$`Analytical sample`

total_p <- nrow(Spectral_table)
```

```{r, include=FALSE}
# Cleaning the TMT10 data
raw_edata <- read.table(tmt10_file, header=TRUE, sep="\t", row.names=1, quote="")
# mylog(raw_edata)

# Subset the raw metrics 

# Ratio header 1, Typical Study, w/ POOL:
us_selection <- grepl("\\.Unshared\\.Log\\.Ratio$", names(raw_edata), perl = TRUE)
s_selection <- grepl("\\.Log\\.Ratio$", names(raw_edata), perl = TRUE)
s_selection <- (s_selection&(!(us_selection)));
samples_ratios = 'Biological Samples'

# Ratio header 2, CompRef:
if (sum(s_selection,na.rm=TRUE) == 0) {
  us_selection <- grepl("^Unshared\\.Log\\.", names(raw_edata), perl = TRUE)
  s_selection <- grepl("^Log\\.", names(raw_edata), perl = TRUE)
  samples_ratios = 'Computed Ratios'
}

# mylog(s_selection)
# mylog(sum(s_selection,na.rm=TRUE))

# Spectral counts headers:
if (sum(s_selection,na.rm=TRUE) == 0) {    
  not_selection <- grepl("^Total\\.", names(raw_edata), perl = TRUE)
  us_selection <- grepl("\\.Unshared\\.Spectral\\.Counts$", names(raw_edata), perl = TRUE)
  s_selection <- grepl("\\.Spectral\\.Counts$", names(raw_edata), perl = TRUE)
  s_selection <- (s_selection&(!(us_selection)));
  s_selection <- (s_selection&(!(not_selection)));
  us_selection <- (us_selection&(!(not_selection)));
  samples_ratios = 'Biological Samples'
}

if (sum(us_selection,na.rm=TRUE) > 0) {
  stopifnot(sum(s_selection,na.rm=TRUE) == sum(us_selection,na.rm=TRUE))
}

if (sum(grepl("^Median$",rownames(raw_edata))) > 0) {
  s_metrics <- tail(raw_edata[,s_selection,drop=FALSE], -3)
} else if (sum(grepl("^Total$",rownames(raw_edata))) > 0) {
  s_metrics <- head(raw_edata[,s_selection,drop=FALSE], -1)
} else {
  s_metrics <- raw_edata[,s_selection,drop=FALSE]
}

orig_s_metrics <- s_metrics

mylog(c(ncol(s_metrics),ncol(Spectral_table)))
stopifnot(ncol(s_metrics) %% ncol(Spectral_table) == 0)

samples_per_analyticalsample = as.integer(ncol(s_metrics)/ncol(Spectral_table))

# Clean the metrics (remove NAs in s_metrics, keep ref_metrics as reference)
ref_metrics <- s_metrics
# mylog(s_metrics)
s_metrics <- s_metrics[complete.cases(s_metrics),,drop=FALSE]
# mylog(s_metrics)


# Construct pheno metrics (s_metrics)
s_sample <- colnames(s_metrics)
s_x <- c(1:(ncol(s_metrics)/samples_per_analyticalsample))
s_batch <- rep(s_x, each=samples_per_analyticalsample)
s_pheno <- data.frame(s_sample, s_batch, row.names=1)
s_pheno$s_batch <- sprintf("%02d",s_pheno$s_batch)
batch = as.factor(s_pheno$s_batch)
#View(s_pheno)

# Compute NAs in ref_metrics for PCA
# for(i in 1:nrow(ref_metrics)){
#   ref_metrics[i, is.na(ref_metrics[i,])] <- min(ref_metrics[i,], na.rm = TRUE)
# }

# Take only the complete rows.
ref_metrics <- s_metrics;
```

```{r,include=FALSE}
# generating a color Palettes for ggvis 
plotcolor <- plotColorPalettes(length(analyticalSamples)) # the number of colors is the same as how many analytical smples in the data. 

# Create color palette for isobaric label 
iso_color = brewer.pal(9, 'Set1')
```

<P/>

# - Input Files

```{r echo=FALSE}
headers = c("Metrics",
	    "Protein Summary",
	    "Peptide Summary",
	    "Quantitation")
values =   c(paste0("<a href=",basename(QCmetrics_file)," target=\"_blank\"><b>",basename(QCmetrics_file),"</b></a>",sep=""),
	     paste0("<a href=",basename(Summary_file)," target=\"_blank\"><b>",basename(Summary_file),"</b></a>",sep=""),
             paste0("<a href=",basename(Peptide_file)," target=\"_blank\"><b>",basename(Peptide_file),"</b></a>",sep=""),
             paste0("<a href=",basename(tmt10_file)," target=\"_blank\"><b>",basename(tmt10_file),"</b></a>",sep=""))

summary_table <- matrix(values, ncol = 1)
rownames(summary_table) <- headers
kable(summary_table, align = 'l',escape=FALSE) %>% 
  kable_styling(bootstrap_options = c("striped","hover"),full_width = F, position="left") %>% column_spec(1, bold = T) 

```
# - Study Summary

```{r echo=FALSE}

# number of analytical samples
nAnalyticalSamples = length(unique(QCmetrics$analyticalBasename))

# Fractions per analytical sample
nFractionsPerAS = length(unique(QCmetrics$Fraction))

# Number of spectral datafiles
nFiles = nrow(QCmetrics)

# Check!
if (params$dochecks) {
  mylog(c(nFiles,nAnalyticalSamples,nFractionsPerAS))
  stopifnot(nFiles == (nAnalyticalSamples * nFractionsPerAS))
}

# proteins identified
nProteins = nrow(SUmetrics)
nProteins1 = cum_id_protein[nrow(all_id_protein),1]
nCommonProteins = all_id_protein[nrow(all_id_protein),1]

protfdr = as.character(MYmetrics[[5]])
protfdr = paste0(as.character(as.numeric(substr(protfdr,1,nchar(protfdr)-1))),"%")

# peptides identified? 
nPeptides = length(unique(PEmetrics$Peptide))

# Ratios computed / Typically "samples" in CPTAC studies
nSamples = ncol(s_metrics)

# Samples per analytical sample: samples_per_analyticalsample 
nSamplesPerAS = samples_per_analyticalsample

# Check!
if (params$dochecks) {
  mylog(c(nSamplesPerAS,nAnalyticalSamples,nSamples))
  stopifnot(nSamplesPerAS * nAnalyticalSamples == nSamples)
}

nMSMSSpectra = sum(QCmetrics$numofMS2_ALL)
nMSMSSpectraID = sum(QCmetrics$numofMS2_ID)

if (regexpr("\\.tmt10(-raw)?\\.tsv$",tmt10_file) != -1) {
    protocol = 'TMT-10'
} else if (regexpr("\\.tmt11(-raw)?\\.tsv$",tmt10_file) != -1) {
    protocol = 'TMT-11'
} else if (regexpr("\\.itraq\\.tsv$",tmt10_file) != -1) {
    protocol = 'iTRAQ-4'
} else if (regexpr("\\.spectral_counts\\.tsv$",tmt10_file) != -1) {
    protocol = 'Label-free'
}

if (regexpr("\\.phospho",tmt10_file) != -1) {
    proteome = "Phosphoproteome"
    # Assumes we have phosphosites as the quantitation file
    nPhosphoSites = nrow(orig_s_metrics)
    # mylog(tmt10_file)
    stopifnot(regexpr("\\.phosphosite\\.",tmt10_file)>=0)
} else {
    proteome = "Whole Proteome"
}

headers = c(samples_ratios,
            "Quantiation Workflow",
            "Analytical Fraction",
            paste(samples_ratios,"per Analytical Sample"),
            "Analytical Samples",
            "Fractions per Analytical Sample",
            "Spectral Datafiles",
            "MS/MS Spectra",
            "Identified MS/MS Spectra (1% FDR)",
            "Peptides",
            paste0("Proteins"," (", protfdr," FDR)"))

values =   c(nSamples,
             protocol,
             proteome,
             nSamplesPerAS,
             nAnalyticalSamples,
             nFractionsPerAS,
             prettyNum(nFiles,big.mark=",",scientific=FALSE),
             prettyNum(nMSMSSpectra,big.mark=",",scientific=FALSE),
             prettyNum(nMSMSSpectraID,big.mark=",",scientific=FALSE),
             prettyNum(nPeptides,big.mark=",",scientific=FALSE),
             prettyNum(nProteins,big.mark=",",scientific=FALSE))

if (proteome == "Phosphoproteome") {
  headers <- append(headers,c("Phosphosites"),after=9);
  values <- append(values,c(prettyNum(nPhosphoSites,big.mark=",",
                                      scientific=FALSE)),after=9);
}

summary_table <- matrix(values, ncol = 1)
rownames(summary_table) <- headers
kable(summary_table, align = 'r') %>% kable_styling(bootstrap_options = c("striped","hover"),full_width = F, position="left") %>% column_spec(1, bold = T) 

```
# - Analytical Samples
```{r echo=FALSE,results='asis'}
t <- table(QCmetrics$analyticalBasenameIndex)
mat_t <- matrix(NA, ncol=3, nrow=length(levels(QCmetrics$analyticalBasenameFactor)))
mat_t[,1] <- sprintf("%02d",1:length(levels(QCmetrics$analyticalBasenameFactor)))
mat_t[,2] <- levels(QCmetrics$analyticalBasenameFactor)
mat_t[,3] <- as.matrix(t)[,1]
colnames(mat_t) <- c("Index","Analytical sample", "Fractions")
kable(mat_t) %>% kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE, position="left")
```

# - Proteins 

## - Proteins by Analytical Sample

Number of identified proteins by analytical sample. 

```{r, fig.height=3.3, fig.width=9.1}
# Generate the Plot 
gg_points_plotly(id_protein,"ProteinCounts",
                 protein_title, as_title)
```

## - Cumulative Proteins by Analytical Sample

Cumulative number of identified proteins by analytical sample. 

```{r, fig.height=3.3, fig.width=9.1}
# Generate the Plot 
gg_points_plotly(cum_id_protein,"ProteinCounts",
                 protein_title, as_title, 0)
```

## - Common Proteins by Analytical Sample

Number of identified proteins in common by analytical sample. 

```{r, fig.height=3.3, fig.width=9.1}
# Generate the Plot 
gg_points_plotly(all_id_protein,"ProteinCounts",
                 protein_title, as_title, 0)
```

# - Peptides

## - Peptides for Fractions by Analytical Sample

Boxplot of number of distinct peptides for fractions by analytical sample. 

```{r}
numofPeptide_ID_per_AS <- tapply(QCmetrics$PeptideCount, 
                                 INDEX=QCmetrics$analyticalBasename, 
                                 FUN=sum)

QCmetrics_AS <- data.frame(analyticalBasename=names(numofPeptide_ID_per_AS),
                           numofPeptide_ID_per_AS=numofPeptide_ID_per_AS)
QCmetrics_AS$`Analytical sample` <- QCmetrics_AS$analyticalBasename

```

```{r,fig.height=2.8, fig.width=9.1}

# get the max and the min number of MS2 peptide counts, including ALL and ID
max_MS2 <- max(QCmetrics$PeptideCount)
min_MS2 <- min(QCmetrics$PeptideCount)

##Get boxplot of number of peptide counts across fractions
g_MS2box_id <- gg_box(QCmetrics, y_string="PeptideCount", x_string="analyticalBasename",
                      col_string="analyticalBasename", label_string="`Analytical sample`")
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=peptide_title) %>% layout(annotations=as_title)

subplot(p_MS2box_id, margin=0.05) ##, titleX=TRUE, titleY=TRUE)

```

## - Peptides for Analytical Samples by Fraction

Number of distinct peptides for analytical samples by fraction. 

```{r,fig.height=2.8, fig.width=9.1}
## Boxplot by Fraction number 
# Reorder Fraction Factor 
#num = table(QCmetrics$analyticalBasenameIndex)[[1]]
#QCmetrics$Fraction <- factor(QCmetrics$Fraction, levels = QCmetrics$Fraction[1:num] )
  
#g_MS2box_id <- gg_box(QCmetrics, y_string="PeptideCount", x_string="Fraction",
#                      col_string="Fraction", label_string="`Analytical sample`")
#p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=peptide_title)
g_DP_byF <- gg_points_frac(QCmetrics,
                           y_string="PeptideCount", 
                           x_string="Fraction",
                           col_string="analyticalBasename",
                           label_string = "`Analytical sample`",
                           smooth=TRUE) + 
	    theme(plot.margin = margin(0.2, 1.0, 0.2, 0.3, "cm"))
p_DP_byF <- ggplotly(g_DP_byF, tooltip=c("label","label2")) %>% layout(annotations=peptide_title) %>% layout(annotations=fr_title)


#subplot(p_MS2box_id, margin=0.05) ##, titleX=TRUE, titleY=TRUE)
subplot(p_DP_byF, margin=0.05) ##, titleX=TRUE, titleY=TRUE)
```

# - MS/MS Spectra

## - MS/MS Spectra by Analytical Sample

Number of MS/MS spectra by analytical sample.

```{r,fig.height=2.8, fig.width=9}

# get the max and the min number of MS2 spectra, including ALL and ID
max_MS2 <- max(max(QCmetrics_AS$numofMS2_ALL_per_AS), 
               max(QCmetrics_AS$numofMS2_ID_per_AS))
min_MS2 <- min(min(QCmetrics_AS$numofMS2_ALL_per_AS), 
               min(QCmetrics_AS$numofMS2_ID_per_AS))

##Get plot of number of spectra
g_MS2box_all <- gg_points(QCmetrics_AS, 
                          y_string="numofMS2_ALL_per_AS", 
                          x_string="analyticalBasename",
                          col_string="analyticalBasename", 
                          label_string="`Analytical sample`",
                          sparse_x_labels=5) +
  theme(plot.margin = margin(0.2, 0.5, 0.2, 0.3, "cm"))
p_MS2box_all <- ggplotly(g_MS2box_all, tooltip=c("label")) %>%
  layout(annotations=all_spect_title) %>% layout(annotations=as_title)

##Get plot of number of spectra
g_MS2box_id <- gg_points(QCmetrics_AS, 
                         y_string="numofMS2_ID_per_AS", 
                         x_string="analyticalBasename",
                         col_string="analyticalBasename", 
                         label_string="`Analytical sample`",                    
                         sparse_x_labels=5) +
	        theme(plot.margin = margin(0.2, 0.5, 0.2, 0.3, "cm"))
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label")) %>% 
  layout(annotations=id_spect_title) %>% layout(annotations=as_title)

subplot(p_MS2box_all,p_MS2box_id, margin=0.05)##, titleX=TRUE, titleY=TRUE)
```

## - MS/MS Spectra for Fractions by Analytical Sample

Boxplot of number of MS/MS spectra for fractions by analytical sample. 

```{r, fig.width=9.3, fig.height=2.8}

# get the max and the min number of MS2 spectra, including ALL and ID
max_MS2 <- max(max(QCmetrics$numofMS2_ALL), max(QCmetrics$numofMS2_ID))
min_MS2 <- min(min(QCmetrics$numofMS2_ALL), min(QCmetrics$numofMS2_ID))


##Get boxplot of number of spectra across fractions
g_MS2box_all <- gg_box(QCmetrics, y_string="numofMS2_ALL", 
                       x_string="analyticalBasename",
                       col_string="analyticalBasename", 
                       label_string="`Analytical sample`",
                       sparse_x_labels=5) +
  theme(plot.margin = margin(0.2, 1.0, 0.2, 0.3, "cm"))
p_MS2box_all <- ggplotly(g_MS2box_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title) %>% layout(annotations=as_title)

##Get boxplot of number of spectra across fractions
g_MS2box_id <- gg_box(QCmetrics, y_string="numofMS2_ID", 
                      x_string="analyticalBasename",
                      col_string="analyticalBasename", 
                      label_string="`Analytical sample`",
                      sparse_x_labels=5) +
  theme(plot.margin = margin(0.2, 1.0, 0.2, 0.3, "cm"))
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title) %>% layout(annotations=as_title)

subplot(p_MS2box_all,p_MS2box_id, margin=0.05)##, titleX=TRUE, titleY=TRUE)

```

## - MS/MS Spectra for Analytical Samples by Fraction

Number of MS/MS spectra for analytical samples by fraction. 

```{r, fig.height=2.8, fig.width=9.3}
g_MS2sca_all <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ALL", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               smooth=TRUE,sparse_x_label=4) +
	        theme(plot.margin = margin(0.2, 1.0, 0.2, 0.5, "cm"))
p_MS2sca_all <- ggplotly(g_MS2sca_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title) %>% layout(annotations=fr_title)

g_MS2sca_id <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ID", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               smooth=TRUE,sparse_x_label=4) +
	        theme(plot.margin = margin(0.2, 1.0, 0.2, 0.5, "cm"))
p_MS2sca_id <- ggplotly(g_MS2sca_id, tooltip=c("label","label2"))  %>% layout(annotations=id_spect_title) %>% layout(annotations=fr_title)

subplot(p_MS2sca_all, p_MS2sca_id, margin=0.05)


```

# - MS/MS Precursors 

## - Precursor Intensity Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of log10(precursor intensity) values for analytical samples by fraction. 

```{r, fig.width=9.3, fig.height=2.8}
# get the smallest and the largest value for all and identified seperately to help set the axis range
# Important! Shaojun add 0.5 value to the min and max value to avoid not ploting the points correctly

Pmin_ALL <- 
  log10(min(subset(QCmetricsLongPrecInt_ALL, value > 0, select=value))) - 0.5
Pmax_ALL <- 
  log10(max(subset(QCmetricsLongPrecInt_ALL, Percentile <= 95,select=value))) + 0.5
Pmin_ID <- 
  log10(min(subset(QCmetricsLongPrecInt_ID, value > 0, select=value))) - 0.5
Pmax_ID <- 
  log10(max(subset(QCmetricsLongPrecInt_ID, Percentile <= 95,select=value)))  + 0.5

QCmetricsLongPrecInt_ALL$value2 <- QCmetricsLongPrecInt_ALL$value
QCmetricsLongPrecInt_ALL$value2[QCmetricsLongPrecInt_ALL$value2 == 0] <-
  min(QCmetricsLongPrecInt_ALL$value2[QCmetricsLongPrecInt_ALL$value2 > 0])*0.5

QCmetricsLongPrecInt_ID$value2 <- QCmetricsLongPrecInt_ID$value
QCmetricsLongPrecInt_ID$value2[QCmetricsLongPrecInt_ID$value2 == 0] <-
  min(QCmetricsLongPrecInt_ID$value2[QCmetricsLongPrecInt_ID$value2 > 0])*0.5

gg_pfp_plotly_all_id(QCmetricsLongPrecInt_ALL, QCmetricsLongPrecInt_ID,
                     y_string="log10(value2)",
                     min_y_all=min(Pmin_ALL, Pmin_ID), 
                     max_y_all=max(Pmax_ALL, Pmax_ID),
                     min_y_id=min(Pmin_ALL,Pmin_ID), 
                     max_y_id=max(Pmax_ALL, Pmax_ID),
                     annot_all_1=all_spect_title_grid,
                     annot_all_2=fr_title,
                     annot_id_1=id_spect_title_grid,
                     annot_id_2=fr_title)
```

## - Precursor m/z Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of precursor m/z values for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=2.8}
gg_pfp_plotly_all_id(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID,
                     y_string="value",
                     min_y_all=find_min(QCmetricsLongPrecMZ_ALL,
                                        QCmetricsLongPrecMZ_ID), 
                     max_y_all=find_max(QCmetricsLongPrecMZ_ALL,
                                        QCmetricsLongPrecMZ_ID),
                     min_y_id=find_min(QCmetricsLongPrecMZ_ALL,
                                       QCmetricsLongPrecMZ_ID), 
                     max_y_id=find_max(QCmetricsLongPrecMZ_ALL,
                                       QCmetricsLongPrecMZ_ID),
                     annot_all_1=all_spect_title_grid,
                     annot_all_2=fr_title,
                     annot_id_1=id_spect_title_grid,
                     annot_id_2=fr_title)
```

## - Precursor Molecular Weight Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of precursor molecular weight values for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=2.8}
gg_pfp_plotly_all_id(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID,
                     y_string="value",
                     min_y_all=find_min(QCmetricsLongPrecMW_ALL,
                                        QCmetricsLongPrecMW_ID), 
                     max_y_all=find_max(QCmetricsLongPrecMW_ALL,
                                        QCmetricsLongPrecMW_ID),
                     min_y_id=find_min(QCmetricsLongPrecMW_ALL,
                                       QCmetricsLongPrecMW_ID), 
                     max_y_id=find_max(QCmetricsLongPrecMW_ALL,
                                       QCmetricsLongPrecMW_ID),
                     annot_all_1=all_spect_title_grid,
                     annot_all_2=fr_title,
                     annot_id_1=id_spect_title_grid,
                     annot_id_2=fr_title)
```

## - Precursor Charge State Distribution

Overall precursor charge state distribution. 


```{r,fig.height=3.4, fig.width=9}
##Get plot of number of spectra
g_cr_id <- gg_bars(Chargeratio_ID, 
                   y_string="chargestateratio_ID", x_string="chargestate",
                   col_string="chargestate", label_string="`Proportion`")
p_cr_id <- ggplotly(g_cr_id, tooltip=c("label")) %>% 
  layout(annotations=id_spect_title, 
         legend=list(orientation = "h", x = 0.25, y = -0.5, 
                     xanchor = "left", yanchor = "bottom"))

##Get plot of number of spectra
g_cr_all <- gg_bars(Chargeratio_ALL, 
                    y_string="chargestateratio_ALL", x_string="chargestate",
                    col_string="chargestate", label_string="`Proportion`")
p_cr_all <- ggplotly(g_cr_all, tooltip=c("label")) %>% 
  layout(annotations=all_spect_title)

subplot(style(p_cr_all, showlegend = FALSE), 
        style(p_cr_id, showlegend = TRUE), margin=0.05)##, titleX=TRUE, titleY=TRUE)
```

## - MS/MS Spectra per Cycle Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of the number of MS/MS spectra per cycle for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=2.8}
gg_pfp_plotly_all_id(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID,
                     y_string="value",
                     min_y_all=find_min(QCmetricsLongMS2perMS_ALL,
                                        QCmetricsLongMS2perMS_ID), 
                     max_y_all=find_max(QCmetricsLongMS2perMS_ALL,
                                        QCmetricsLongMS2perMS_ID),
                     min_y_id=find_min(QCmetricsLongMS2perMS_ALL,
                                       QCmetricsLongMS2perMS_ID), 
                     max_y_id=find_max(QCmetricsLongMS2perMS_ALL,
                                       QCmetricsLongMS2perMS_ID),
                     annot_all_1=all_spect_title_grid,
                     annot_all_2=fr_title,
                     annot_id_1=id_spect_title_grid,
                     annot_id_2=fr_title)

min.ms2perms1=find_min(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID)

```

## - Peptide Redundancy Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of peptide redundancy for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=3.3}
g_id <- gg_points_frac_perc(filter(QCmetricsPeptideRd, 
                                   Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            #min_y=find_min(QCmetricsPeptideRd),
                            min_y = min(subset(QCmetricsPeptideRd, 
                                               Percentile <= 95,select=c(value))),
                            #max_y=find_max(QCmetricsPeptideRd))
                            max_y = max(subset(QCmetricsPeptideRd, 
                                               Percentile <= 95,select=c(value))),
                            sparse_x_labels=4)

p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=peptide_rd, hovermode = 'compare') %>% layout(annotations=fr_title)


subplot(p_id, margin=0.05)

```

# - Chromatography

## - Retention Time Percentiles for Analytical Sample by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of chromatographic retention time for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=2.8}
gg_pfp_plotly_all_id(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID,
                     y_string="value",
                     min_y_all=find_min(QCmetricsPeptideRT_ALL,
                                        QCmetricsPeptideRT_ID), 
                     max_y_all=find_max(QCmetricsPeptideRT_ALL,
                                        QCmetricsPeptideRT_ID),
                     min_y_id=find_min(QCmetricsPeptideRT_ALL,
                                       QCmetricsPeptideRT_ID), 
                     max_y_id=find_max(QCmetricsPeptideRT_ALL,
                                       QCmetricsPeptideRT_ID),
                     annot_all_1=all_spect_title_grid,
                     annot_all_2=fr_title,
                     annot_id_1=id_spect_title_grid,
                     annot_id_2=fr_title)

```
```{r, child = if (nSamples > 2 | protocol != 'Label-free') 'batchhdr.Rmd' else 'empty.Rmd'} 
```
```{r, child = if (nSamples > 2) 'analsamp.Rmd' else 'empty.Rmd'} 
```
```{r, child = if (protocol != 'Label-free') 'isolabels.Rmd' else 'empty.Rmd'} 
```

<font size="2">*For more information about **Plotly Modebar**, click <a href="https://help.plot.ly/getting-to-know-the-plotly-modebar/" target="_blank"><b>here</b></a>.*</font>


<!--Javascript-->
<!--Show(scroll to left)/Hide(scroll to right) TOC-->
<script>
var lastPos = 0;
$(window).scroll(function() {
    var currPos = $(document).scrollLeft();
    if (lastPos < currPos) 
    {$('#TOC').css('opacity', 0);} 
    if (lastPos > currPos) 
    {$('#TOC').css('opacity', 1);}
    lastPos = currPos;
});
</script>
