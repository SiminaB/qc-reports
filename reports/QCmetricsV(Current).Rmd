---
title: "Proteomic Consistency Metrics"
author: "Simina Boca, Shaojun Tang, Yi Bai, Nathan Edwards"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
params:
  qcmetricsfile: inputfilename.tsv
  format: html_document
output:
  html_document:
    number_sections: yes
    smooth_scroll: no
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r, warning=FALSE, include=FALSE}
library(ggplot2)
library(reshape2)
library(knitr)
library(kableExtra)
library(RColorBrewer) ## generate palette
library(grid)
library(pander) ## this package is used ot convert the .md file into PDF
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(gridExtra)) ## to show the plots side by side 
suppressPackageStartupMessages(library(plotly))
options(warn = -1)
```

```{r}
# this allows the kable function work in html format to make pretty tables
#but will not work in the PDF files, remember to remove it if generating PDF files
#also remving the lines with kable in the code chunks related
if (params$format != 'pdf_document') {
  options(knitr.table.format = "html")  
}
```

```{r,include=FALSE}
##Read in metrics for individual analytical samples and fractions and check number of fractions and samples

#files <- list.files(".") 

# Load from the Input forder (Jiahao)
files <- list.files("./Input")

#files <- list.files("d:/research/Collaborations/CPTAC/mzML/SourceCode/")  # (".")

# Current Working Metrics (Jiahao)
#QCmetrics.files <- files[grep("CPTAC3_Uterine_Corpus_Endometrial_Carcinoma_CompRef_Proteome.qcmetrics.tsv",files)]
#QCmetrics.files <- files[grep("SEER_PNNL_Phosphoproteome.qcmetrics.tsv",files)]
QCmetrics_file <- files[grep("CPTAC3_Clear_Cell_Renal_Cell_Carcinoma_Proteome.qcmetrics.tsv",files)]


#QCmetrics <- read.table(paste0("d:/research/Collaborations/CPTAC/mzML/SourceCode/", QCmetrics_file), header=TRUE, sep="\t")

#QCmetrics <- read.table(QCmetrics.files, header=TRUE, sep="\t")
QCmetrics <- read.table(paste0("~/Desktop/CPTAC_3 /Input/", QCmetrics_file), header=TRUE, sep="\t")

dim(QCmetrics)
head(QCmetrics)

QCmetrics <- QCmetrics[, !duplicated(colnames(QCmetrics))]
##rename "fractionNum" to "Fraction"
QCmetrics <- rename(QCmetrics, Fraction=fractionNum)

## New function to replace the CPTAC with "" (Jiahao) (test)
#split_CPTAC <- function(x) {
  #fc_levels <- levels(x)
  #new_levels <- gsub("[[:punct:]]?(CPTAC)[[:punct:]]?", "", fc_levels, perl = TRUE)
  #mapvalues(x, from = fc_levels, to = new_levels)
#}

QCmetrics$analyticalBasenameLabel <- QCmetrics$analyticalBasename
QCmetrics$analyticalBasenameFactor <- factor(QCmetrics$analyticalBasenameLabel)
QCmetrics$analyticalBasenameIndex <- as.numeric(QCmetrics$analyticalBasenameFactor)
QCmetrics$analyticalBasename <- QCmetrics$analyticalBasenameIndex

# if these are left as numbers, the color scale is messed up. Why?
QCmetrics$analyticalBasename <- as.character(QCmetrics$analyticalBasename)

##add some new columns to QCmetrics (same as other columns, but useful for tooltip!)
QCmetrics$`Analytical sample` <- QCmetrics$analyticalBasename

##get total number of spectra per analytical sample
numofMS2_ALL_per_AS <- tapply(QCmetrics$numofMS2_ALL, INDEX=QCmetrics$analyticalBasename, FUN=sum)
numofMS2_ID_per_AS <- tapply(QCmetrics$numofMS2_ID, INDEX=QCmetrics$analyticalBasename, FUN=sum)
identical(names(numofMS2_ALL_per_AS), names(numofMS2_ID_per_AS))

QCmetrics_AS <- data.frame(analyticalBasename=names(numofMS2_ID_per_AS),
                           numofMS2_ALL_per_AS=numofMS2_ALL_per_AS,
                           numofMS2_ID_per_AS=numofMS2_ID_per_AS)
QCmetrics_AS$`Analytical sample` <- QCmetrics_AS$analyticalBasename
```

```{r,include=FALSE}
##need to separate out the fractions if they are all equal to NA (this means they have not been pulled out before)
if(sum(!is.na(QCmetrics$Fraction)) == 0)
{
  analyticalBasenameSplit <- strsplit(as.character(QCmetrics$analyticalBasename),"_Fr_")
  QCmetrics$analyticalBasename <- sapply(analyticalBasenameSplit, function(x){x[1]})
  QCmetrics$Fraction <- as.numeric(sapply(analyticalBasenameSplit, function(x){x[2]}))
  unique(QCmetrics$Fraction)
  QCmetrics$Fraction[is.na(QCmetrics$Fraction)] <- 25
}

##Get the fractions (check they are 1-24):
##Ugh - should use a better marker for "A" - how about 1000? or -1? or #unique fraction values? 
##QCmetrics file will have an A in the fraction position, not NA, from now on. Handle this explicitly. 

sort(unique(QCmetrics$Fraction))
length(unique(QCmetrics$Fraction))

QCmetrics$Fraction[is.na(QCmetrics$Fraction)] <- 25
```

```{r, include=FALSE}
##Get the number of unique analytical samples

analyticalSamples <- unique(QCmetrics$analyticalBasename)
length(analyticalSamples)

##Make sure the labels in spectrumBasename are unique

length(unique(QCmetrics$spectrumBasename))

##Get the number of unique fractions
fractions <- unique(QCmetrics$Fraction)
```

```{r,include=FALSE}
##Change some column names to make things easier
QCmetrics <- rename(QCmetrics,
                    PrecursorIntensityALL.0 = minPrecursorIntensity_ALL,
                    PrecursorIntensityALL.5 = PrecursorIntensity5perc_ALL,
                    PrecursorIntensityALL.25 = PrecursorIntensity25perc_ALL,
                    PrecursorIntensityALL.50 = PrecursorIntensity50perc_ALL,
                    PrecursorIntensityALL.75 = PrecursorIntensity75perc_ALL,
                    PrecursorIntensityALL.95 = PrecursorIntensity95perc_ALL,
                    PrecursorIntensityALL.100 = maxPrecursorIntensity_ALL)
QCmetrics <- rename(QCmetrics,
                    PrecursorMZALL.0 = minPrecursorMZ_ALL,
                    PrecursorMZALL.5 = PrecursorMZ5perc_ALL,
                    PrecursorMZALL.25 = PrecursorMZ25perc_ALL,
                    PrecursorMZALL.50 = PrecursorMZ50perc_ALL,
                    PrecursorMZALL.75 = PrecursorMZ75perc_ALL,
                    PrecursorMZALL.95 = PrecursorMZ95perc_ALL,
                    PrecursorMZALL.100 = maxPrecursorMZ_ALL)

QCmetrics <- rename(QCmetrics,
                    PrecursorMWALL.0 = minPrecursorMW_ALL,
                    PrecursorMWALL.5 = PrecursorMW5perc_ALL,
                    PrecursorMWALL.25 = PrecursorMW25perc_ALL,
                    PrecursorMWALL.50 = PrecursorMW50perc_ALL,
                    PrecursorMWALL.75 = PrecursorMW75perc_ALL,
                    PrecursorMWALL.95 = PrecursorMW95perc_ALL,
                    PrecursorMWALL.100 = maxPrecursorMW_ALL)

QCmetrics <- rename(QCmetrics,
                    MS2perMS1ALL.0 = minMS2perMS1_ALL,
                    MS2perMS1ALL.5 = MS2perMS1_5perc_ALL,
                    MS2perMS1ALL.25 = MS2perMS1_25perc_ALL,
                    MS2perMS1ALL.50 = MS2perMS1_50perc_ALL,
                    MS2perMS1ALL.75 = MS2perMS1_75perc_ALL,
                    MS2perMS1ALL.95 = MS2perMS1_95perc_ALL,
                    MS2perMS1ALL.100 = maxMS2perMS1_ALL)

QCmetrics <- rename(QCmetrics,
                    MS2chargeALL.1 = MS2Charge1_ALL,
                    MS2chargeALL.2 = MS2Charge2_ALL,
                    MS2chargeALL.3 = MS2Charge3_ALL,
                    MS2chargeALL.4 = MS2Charge4_ALL,
                    MS2chargeALL.5andhigher = MS2Charge5_ALL##MS2Charge5andHigher_ALL,
                   )

## Adding Redundancy (Jiahao)
QCmetrics <- rename(QCmetrics,
                    PeptideRd.0 = minPeptideRedundancy,
                    PeptideRd.5 = PeptideRedundancy5perc,
                    PeptideRd.25 = PeptideRedundancy25perc,
                    PeptideRd.50 = PeptideRedundancy50perc,
                    PeptideRd.75 = PeptideRedundancy75perc,
                    PeptideRd.95 = PeptideRedundancy95perc,
                    PeptideRd.100 = maxPeptideRedundancy)

# Adding Retention Time ALL
QCmetrics <- rename(QCmetrics,
                    RetentionTimeALL.0 = minRetentionTime_ALL,
                    RetentionTimeALL.5 = RetentionTime5perc_ALL,
                    RetentionTimeALL.25 = RetentionTime25perc_ALL,
                    RetentionTimeALL.50 = RetentionTime50perc_ALL,
                    RetentionTimeALL.75 = RetentionTime75perc_ALL,
                    RetentionTimeALL.95 = RetentionTime95perc_ALL,
                    RetentionTimeALL.100 = maxRetentionTime_ALL)

charge0avail <- FALSE
if ("MS2Charge0_ALL" %in% colnames(QCmetrics)) {
    QCmetrics <- rename(QCmetrics,
                        MS2chargeALL.0 = MS2Charge0_ALL)
    charge0avail <- TRUE
}

##Create data frame melting the precursor intensities
QCmetricsLongPrecInt_ALL <- melt(QCmetrics[,c(2,3,grep("PrecursorIntensityALL.",colnames(QCmetrics)))],
                             variable.name="PrecursorIntensityALL",
                             value.name="value",
                             id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecInt_ALL)
QCmetricsLongPrecInt_ALL <- cbind(QCmetricsLongPrecInt_ALL[,1:2],
                              colsplit(QCmetricsLongPrecInt_ALL[,3], "\\.",
                                       c("PrecursorIntensityALL","Percentile")),
                              QCmetricsLongPrecInt_ALL[,4])
head(QCmetricsLongPrecInt_ALL)
colnames(QCmetricsLongPrecInt_ALL)[5] <- "value"

QCmetricsLongPrecInt_ALL$`Analytical sample` <- QCmetricsLongPrecInt_ALL$analyticalBasename
QCmetricsLongPrecInt_ALL$Fraction <- QCmetricsLongPrecInt_ALL$Fraction

##Create data frame melting the precursor MZ values
QCmetricsLongPrecMZ_ALL <- melt(QCmetrics[,c(2,3,grep("PrecursorMZALL.",colnames(QCmetrics)))],
                            variable.name="PrecursorMZALL",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecMZ_ALL)
QCmetricsLongPrecMZ_ALL <- cbind(QCmetricsLongPrecMZ_ALL[,1:2],
                             colsplit(QCmetricsLongPrecMZ_ALL[,3], "\\.",
                                      c("PrecursorMZALL","Percentile")),
                             QCmetricsLongPrecMZ_ALL[,4])
head(QCmetricsLongPrecMZ_ALL)
colnames(QCmetricsLongPrecMZ_ALL)[5] <- "value"

QCmetricsLongPrecMZ_ALL$`Analytical sample` <- QCmetricsLongPrecMZ_ALL$analyticalBasename
QCmetricsLongPrecMZ_ALL$Fraction <- QCmetricsLongPrecMZ_ALL$Fraction

##Create data frame melting the precursor MW values
QCmetricsLongPrecMW_ALL <- melt(QCmetrics[,c(2,3,grep("PrecursorMWALL.",colnames(QCmetrics)))],
                            variable.name="PrecursorMWALL",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecMW_ALL)
QCmetricsLongPrecMW_ALL <- cbind(QCmetricsLongPrecMW_ALL[,1:2],
                             colsplit(QCmetricsLongPrecMW_ALL[,3], "\\.",
                                      c("PrecursorMWALL","Percentile")),
                             QCmetricsLongPrecMW_ALL[,4])
head(QCmetricsLongPrecMW_ALL)
colnames(QCmetricsLongPrecMW_ALL)[5] <- "value"

QCmetricsLongPrecMW_ALL$`Analytical sample` <- QCmetricsLongPrecMW_ALL$analyticalBasename
QCmetricsLongPrecMW_ALL$Fraction <- QCmetricsLongPrecMW_ALL$Fraction

##Create data frame melting the MS2perMS values
QCmetricsLongMS2perMS_ALL <- melt(QCmetrics[,c(2,3,grep("MS2perMS1ALL.",colnames(QCmetrics)))],
                              variable.name=" MS2perMS1ALL",
                            value.name="value",
                              id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongMS2perMS_ALL)
QCmetricsLongMS2perMS_ALL <- cbind(QCmetricsLongMS2perMS_ALL[,1:2],
                               colsplit(QCmetricsLongMS2perMS_ALL[,3], "\\.",
                                        c("MS2perMS1ALL","Percentile")),
                               QCmetricsLongMS2perMS_ALL[,4])
head(QCmetricsLongMS2perMS_ALL)
colnames(QCmetricsLongMS2perMS_ALL)[5] <- "value"

QCmetricsLongMS2perMS_ALL$`Analytical sample` <- QCmetricsLongMS2perMS_ALL$analyticalBasename
QCmetricsLongMS2perMS_ALL$Fraction <- QCmetricsLongMS2perMS_ALL$Fraction

##Create data frame melting MS2 charge ratio
QCmetricsLongMS2Charge_ALL <- melt(QCmetrics[,c(2,3,grep("MS2chargeALL.",colnames(QCmetrics)))],
                                    variable.name="MS2chargeALL",
                                    value.name="value",
                                    id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongMS2Charge_ALL)
QCmetricsLongMS2Charge_ALL <- cbind(QCmetricsLongMS2Charge_ALL[,1:2],
                                     colsplit(QCmetricsLongMS2Charge_ALL[,3], "\\.", c("MS2chargeALL","MS2ChargeState")),
                                     QCmetricsLongMS2Charge_ALL[,4])
head(QCmetricsLongMS2Charge_ALL)
colnames(QCmetricsLongMS2Charge_ALL)[5] <- "value"
QCmetricsLongMS2Charge_ALL$MS2chargeALL <- NULL
totalMS2_ALL = sum(QCmetricsLongMS2Charge_ALL$value)
QCmetricsLongMS2Charge_ALL$Chargeratio<- c(QCmetricsLongMS2Charge_ALL$value/totalMS2_ALL)

QCmetricsLongMS2Charge_ALL$`Analytical sample` <- QCmetricsLongMS2Charge_ALL$analyticalBasename
QCmetricsLongMS2Charge_ALL$Fraction <- QCmetricsLongMS2Charge_ALL$Fraction



# Create data frame melting Peptie Redundancy (Jiahao)
QCmetricsPeptideRd <- melt(QCmetrics[,c(2,3,grep("PeptideRd.",colnames(QCmetrics)))],
                            variable.name="PeptideRd",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsPeptideRd)
QCmetricsPeptideRd <- cbind(QCmetricsPeptideRd[,1:2],
                             colsplit(QCmetricsPeptideRd[,3], "\\.",
                                      c("PeptideRd","Percentile")),
                             QCmetricsPeptideRd[,4])
head(QCmetricsPeptideRd)
colnames(QCmetricsPeptideRd)[5] <- "value"

QCmetricsPeptideRd$`Analytical sample` <- QCmetricsPeptideRd$analyticalBasename
QCmetricsPeptideRd$Fraction <- QCmetricsPeptideRd$Fraction

# Create data frame melting Retention Time All
QCmetricsPeptideRT_ALL <- melt(QCmetrics[,c(2,3,grep("RetentionTimeALL.",colnames(QCmetrics)))],
                            variable.name="RetentionTimeALL",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsPeptideRT_ALL)
QCmetricsPeptideRT_ALL <- cbind(QCmetricsPeptideRT_ALL[,1:2],
                             colsplit(QCmetricsPeptideRT_ALL[,3], "\\.",
                                      c("RetentionTimeALL","Percentile")),
                             QCmetricsPeptideRT_ALL[,4])
head(QCmetricsPeptideRT_ALL)
colnames(QCmetricsPeptideRT_ALL)[5] <- "value"

QCmetricsPeptideRT_ALL$`Analytical sample` <- QCmetricsPeptideRT_ALL$analyticalBasename
QCmetricsPeptideRT_ALL$Fraction <- QCmetricsPeptideRT_ALL$Fraction


# Create dataframe for different charge state
# Create the label
if (charge0avail) {
  chargestate <- c("N/A","+1","+2", "+3","+4","5 and Higher")
} else {
  chargestate <- c("+1","+2", "+3","+4","5 and Higher")
}

#calculate the ratio for each of the charge state   
chargestateratio_ALL <- 
  c(sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == 1,select=c(Chargeratio))), 
    sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == 2,select=c(Chargeratio))), 
    sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == 3,select=c(Chargeratio))), 
    sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == 4,select=c(Chargeratio))), 
    sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == "5andhigher",select=c(Chargeratio))))

if (charge0avail) {
  chargestateratio_ALL <- c(sum(subset(QCmetricsLongMS2Charge_ALL,                                                                       MS2ChargeState == 0,select=c(Chargeratio))),chargestateratio_ALL)
}

#generate the data frame contains the cahrge ratio
Chargeratio_ALL <- data.frame(chargestate, chargestateratio_ALL)


# Create data frame melting Peptie Redundancy (Jiahao)
QCmetricsPeptideRd <- melt(QCmetrics[,c(2,3,grep("PeptideRd.",colnames(QCmetrics)))],
                            variable.name="PeptideRd",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsPeptideRd)
QCmetricsPeptideRd <- cbind(QCmetricsPeptideRd[,1:2],
                             colsplit(QCmetricsPeptideRd[,3], "\\.",
                                      c("PeptideRd","Percentile")),
                             QCmetricsPeptideRd[,4])
head(QCmetricsPeptideRd)
colnames(QCmetricsPeptideRd)[5] <- "value"

QCmetricsPeptideRd$`Analytical sample` <- QCmetricsPeptideRd$analyticalBasename
QCmetricsPeptideRd$Fraction <- QCmetricsPeptideRd$Fraction

# Create data frame melting Retention Time All
QCmetricsPeptideRT_ALL <- melt(QCmetrics[,c(2,3,grep("RetentionTimeALL.",colnames(QCmetrics)))],
                            variable.name="RetentionTimeALL",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsPeptideRT_ALL)
QCmetricsPeptideRT_ALL <- cbind(QCmetricsPeptideRT_ALL[,1:2],
                             colsplit(QCmetricsPeptideRT_ALL[,3], "\\.",
                                      c("RetentionTimeALL","Percentile")),
                             QCmetricsPeptideRT_ALL[,4])
head(QCmetricsPeptideRT_ALL)
colnames(QCmetricsPeptideRT_ALL)[5] <- "value"

QCmetricsPeptideRT_ALL$`Analytical sample` <- QCmetricsPeptideRT_ALL$analyticalBasename
QCmetricsPeptideRT_ALL$Fraction <- QCmetricsPeptideRT_ALL$Fraction

```


```{r,include=FALSE}
##Change some column names to make things easier
QCmetrics <- rename(QCmetrics,
                    PrecursorIntensityID.0 = minPrecursorIntensity_ID,
                    PrecursorIntensityID.5 = PrecursorIntensity5perc_ID,
                    PrecursorIntensityID.25 = PrecursorIntensity25perc_ID,
                    PrecursorIntensityID.50 = PrecursorIntensity50perc_ID,
                    PrecursorIntensityID.75 = PrecursorIntensity75perc_ID,
                    PrecursorIntensityID.95 = PrecursorIntensity95perc_ID,
                    PrecursorIntensityID.100 = maxPrecursorIntensity_ID)
QCmetrics <- rename(QCmetrics,
                    PrecursorMZID.0 = minPrecursorMZ_ID,
                    PrecursorMZID.5 = PrecursorMZ5perc_ID,
                    PrecursorMZID.25 = PrecursorMZ25perc_ID,
                    PrecursorMZID.50 = PrecursorMZ50perc_ID,
                    PrecursorMZID.75 = PrecursorMZ75perc_ID,
                    PrecursorMZID.95 = PrecursorMZ95perc_ID,
                    PrecursorMZID.100 = maxPrecursorMZ_ID)

QCmetrics <- rename(QCmetrics,
                    PrecursorMWID.0 = minPrecursorMW_ID,
                    PrecursorMWID.5 = PrecursorMW5perc_ID,
                    PrecursorMWID.25 = PrecursorMW25perc_ID,
                    PrecursorMWID.50 = PrecursorMW50perc_ID,
                    PrecursorMWID.75 = PrecursorMW75perc_ID,
                    PrecursorMWID.95 = PrecursorMW95perc_ID,
                    PrecursorMWID.100 = maxPrecursorMW_ID)

QCmetrics <- rename(QCmetrics,
                    MS2perMS1ID.0 = minMS2perMS1_ID,
                    MS2perMS1ID.5 = MS2perMS1_5perc_ID,
                    MS2perMS1ID.25 = MS2perMS1_25perc_ID,
                    MS2perMS1ID.50 = MS2perMS1_50perc_ID,
                    MS2perMS1ID.75 = MS2perMS1_75perc_ID,
                    MS2perMS1ID.95 = MS2perMS1_95perc_ID,
                    MS2perMS1ID.100 = maxMS2perMS1_ID)
QCmetrics <- rename(QCmetrics,
                    MS2chargeID.1 = MS2Charge1_ID,
                    MS2chargeID.2 = MS2Charge2_ID,
                    MS2chargeID.3 = MS2Charge3_ID,
                    MS2chargeID.4 = MS2Charge4_ID,
                    MS2chargeID.5andhigher = MS2Charge5_ID##MS2Charge5andHigher_ID,
                   )

# Adding Retention Time ID (Jiahao)
QCmetrics <- rename(QCmetrics,
                    RetentionTimeID.0 = minRetentionTime_ID,
                    RetentionTimeID.5 = RetentionTime5perc_ID,
                    RetentionTimeID.25 = RetentionTime25perc_ID,
                    RetentionTimeID.50 = RetentionTime50perc_ID,
                    RetentionTimeID.75 = RetentionTime75perc_ID,
                    RetentionTimeID.95 = RetentionTime95perc_ID,
                    RetentionTimeID.100 = maxRetentionTime_ID)

if ("MS2Charge0_ID" %in% colnames(QCmetrics)) {
    QCmetrics <- rename(QCmetrics,
                        MS2chargeID.0 = MS2Charge0_ID)
}

##Create data frame melting the precursor intensities
QCmetricsLongPrecInt_ID <- melt(QCmetrics[,c(2,3,grep("PrecursorIntensityID.",colnames(QCmetrics)))],
                             variable.name="PrecursorIntensityID",
                             value.name="value",
                             id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecInt_ID)
QCmetricsLongPrecInt_ID <- cbind(QCmetricsLongPrecInt_ID[,1:2],
                              colsplit(QCmetricsLongPrecInt_ID[,3], "\\.",
                                       c("PrecursorIntensityID","Percentile")),
                              QCmetricsLongPrecInt_ID[,4])
head(QCmetricsLongPrecInt_ID)
colnames(QCmetricsLongPrecInt_ID)[5] <- "value"

QCmetricsLongPrecInt_ID$`Analytical sample` <- QCmetricsLongPrecInt_ID$analyticalBasename
QCmetricsLongPrecInt_ID$Fraction <- QCmetricsLongPrecInt_ID$Fraction

##Create data frame melting the precursor MZ values
QCmetricsLongPrecMZ_ID <- melt(QCmetrics[,c(2,3,grep("PrecursorMZID.",colnames(QCmetrics)))],
                            variable.name="PrecursorMZID",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecMZ_ID)
QCmetricsLongPrecMZ_ID <- cbind(QCmetricsLongPrecMZ_ID[,1:2],
                             colsplit(QCmetricsLongPrecMZ_ID[,3], "\\.",
                                      c("PrecursorMZID","Percentile")),
                             QCmetricsLongPrecMZ_ID[,4])
head(QCmetricsLongPrecMZ_ID)
colnames(QCmetricsLongPrecMZ_ID)[5] <- "value"

QCmetricsLongPrecMZ_ID$`Analytical sample` <- QCmetricsLongPrecMZ_ID$analyticalBasename
QCmetricsLongPrecMZ_ID$Fraction <- QCmetricsLongPrecMZ_ID$Fraction

##Create data frame melting the precursor MW values
QCmetricsLongPrecMW_ID <- melt(QCmetrics[,c(2,3,grep("PrecursorMWID.",colnames(QCmetrics)))],
                            variable.name="PrecursorMWID",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecMW_ID)
QCmetricsLongPrecMW_ID <- cbind(QCmetricsLongPrecMW_ID[,1:2],
                             colsplit(QCmetricsLongPrecMW_ID[,3], "\\.",
                                      c("PrecursorMWID","Percentile")),
                             QCmetricsLongPrecMW_ID[,4])
head(QCmetricsLongPrecMW_ID)
colnames(QCmetricsLongPrecMW_ID)[5] <- "value"

QCmetricsLongPrecMW_ID$`Analytical sample` <- QCmetricsLongPrecMW_ID$analyticalBasename
QCmetricsLongPrecMW_ID$Fraction <- QCmetricsLongPrecMW_ID$Fraction


##Create data frame melting the MS2perMS values
QCmetricsLongMS2perMS_ID <- melt(QCmetrics[,c(2,3,grep("MS2perMS1ID.",colnames(QCmetrics)))],
                              variable.name=" MS2perMS1",
                              value.name="value",
                              id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongMS2perMS_ID)
QCmetricsLongMS2perMS_ID <- cbind(QCmetricsLongMS2perMS_ID[,1:2],
                               colsplit(QCmetricsLongMS2perMS_ID[,3], "\\.",
                                        c("MS2perMS1ID","Percentile")),
                               QCmetricsLongMS2perMS_ID[,4])
head(QCmetricsLongMS2perMS_ID)
colnames(QCmetricsLongMS2perMS_ID)[5] <- "value"

QCmetricsLongMS2perMS_ID$`Analytical sample` <- QCmetricsLongMS2perMS_ID$analyticalBasename
QCmetricsLongMS2perMS_ID$Fraction <- QCmetricsLongMS2perMS_ID$Fraction

##Create data frame melting MS2 charge ratio
QCmetricsLongMS2Charge_ID <- melt(QCmetrics[,c(2,3,grep("MS2chargeID.",colnames(QCmetrics)))],
                                    variable.name="MS2chargeID",
                                    value.name="value",
                                    id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongMS2Charge_ID)
QCmetricsLongMS2Charge_ID <- cbind(QCmetricsLongMS2Charge_ID[,1:2],
                                     colsplit(QCmetricsLongMS2Charge_ID[,3], "\\.", c("MS2chargeID","MS2ChargeState")),
                                     QCmetricsLongMS2Charge_ID[,4])
head(QCmetricsLongMS2Charge_ID)
colnames(QCmetricsLongMS2Charge_ID)[5] <- "value"
QCmetricsLongMS2Charge_ID$MS2chargeID <- NULL
totalMS2_ID = sum(QCmetricsLongMS2Charge_ID$value)
QCmetricsLongMS2Charge_ID$Chargeratio<- c(QCmetricsLongMS2Charge_ID$value/totalMS2_ID)

QCmetricsLongMS2Charge_ID$`Analytical sample` <- QCmetricsLongMS2Charge_ID$analyticalBasename
QCmetricsLongMS2Charge_ID$Fraction <- QCmetricsLongMS2Charge_ID$Fraction

# calculate the values for charge distribution for differnt cahrge state 
chargestateratio_ID <- c(sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == 1,select=c(Chargeratio))), sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == 2,select=c(Chargeratio))), sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == 3,select=c(Chargeratio))), sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == 4,select=c(Chargeratio))), sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == "5andhigher",select=c(Chargeratio))))
if (charge0avail) {
  chargestateratio_ID <- c(sum(subset(QCmetricsLongMS2Charge_ID,                                                                       MS2ChargeState == 0,select=c(Chargeratio))),chargestateratio_ID)
}

#generate the data frame contains the cahrge ratio
Chargeratio_ID <- data.frame(chargestate, chargestateratio_ID)
summary(Chargeratio_ALL)
summary(Chargeratio_ID)

# Create data frame melting Retention Time ID (Jiahao)
QCmetricsPeptideRT_ID <- melt(QCmetrics[,c(2,3,grep("RetentionTimeID.",colnames(QCmetrics)))],
                            variable.name="RetentionTimeID",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsPeptideRT_ID)
QCmetricsPeptideRT_ID <- cbind(QCmetricsPeptideRT_ID[,1:2],
                             colsplit(QCmetricsPeptideRT_ID[,3], "\\.",
                                      c("RetentionTimeID","Percentile")),
                             QCmetricsPeptideRT_ID[,4])
head(QCmetricsPeptideRT_ID)
colnames(QCmetricsPeptideRT_ID)[5] <- "value"

QCmetricsPeptideRT_ID$`Analytical sample` <- QCmetricsPeptideRT_ID$analyticalBasename
QCmetricsPeptideRT_ID$Fraction <- QCmetricsPeptideRT_ID$Fraction

```

```{r,include=FALSE}
# generating a color Palettes for ggvis 
# plotColorPalettes is the function for generating the pallettes, the colors in the palettes depends on the number we put in 
# in our case, the palettes is called plotcolor

plotColorPalettes <- function(g){
  d <- 360/g
  h <- cumsum(c(15, rep(d,g - 1)))
  hcl(h = h, c = 100, l = 65)
}
plotcolor <- plotColorPalettes(length(analyticalSamples)) # the number of colors is the same as how many analytical smples in the data. 
```

```{r include=FALSE}
all_spect_title <- list(
  text = "All MS/MS Spectra",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1,
  showarrow = FALSE
)

id_spect_title <- list(
  text = "Identified MS/MS Spectra",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1,
  showarrow = FALSE
)

all_spect_title_grid <- list(
  text = "All MS/MS Spectra",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.1,
  showarrow = FALSE
)

id_spect_title_grid <- list(
  text = "Identified MS/MS Spectra",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.1,
  showarrow = FALSE
)

# Add new layout annotation for MS/MS Distinct Peptides for Fractions by Analytical Sample (Jiahao)
peptide_title <- list(
  text = "Distinct MS/MS Peptide",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.0,
  showarrow = FALSE
)

# Add new layout annotation for Redundancy
peptide_rd <- list(
  text = "MS/MS Peptide Redundancy",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.1,
  showarrow = FALSE
)

# Add new layout annotation for Retention time 
id_retention <-  list(
  text = "Identified MS/MS Spectra Retention Time",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.1,
  showarrow = FALSE
)

all_retention <-  list(
  text = "All MS/MS Spectra Retention Time",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.1,
  showarrow = FALSE
)
```

```{r, include=FALSE}
grid_arrange_shared_legend <- function(..., ncol = length(list(...)), nrow = 1, position = c("bottom", "right")) {

  plots <- list(...) 
  position <- match.arg(position)
  g <- ggplotGrob(plots[[1]] +theme(legend.position = position))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  lwidth <- sum(legend$width)
  gl <- lapply(plots, function(x) x + theme(legend.position="none"))
  gl <- c(gl, ncol = ncol, nrow = nrow)

  combined <- switch(position,
                     "bottom" = arrangeGrob(do.call(arrangeGrob, gl),
                                            legend,
                                            ncol = 1,
                                            heights = unit.c(unit(1, "npc") - lheight, lheight)),
                     "right" = arrangeGrob(do.call(arrangeGrob, gl),
                                           legend,
                                           ncol = 2,
                                           widths = unit.c(unit(1, "npc") - lwidth, lwidth)))
  grid.newpage()
  grid.draw(combined)
  # return gtable invisibly
  invisible(combined)

}

```


```{r}

# make a function to compute the max and min value 
##  Only useful for those has different percentiles
### n and m represent 2 differnt data frame that you want to compare with

find_max<-function(n, m)
{
  max_n <- max(max(subset(n, Percentile <= 95,select=c(value))), max(subset(m, Percentile <= 95,select=c(value))))
  return(max_n)
}

#find_max(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID)

find_min <- function(n,m)
{
  min_n <- min(min(subset(n, Percentile <= 95,select=c(value))), min(subset(m, Percentile <= 95,select=c(value))))
  return(min_n)
}

# create title for each of the plot 
title_ALL <- "Number of Raw MS/MS Spectra"
title_ID <-  "Number of Identified MS/MS Spectra"

#find_min(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID)
```

```{r}

# Build a function for generating the a table with 
## we have 2 parameter one is the kind we want for rows and the other is the dataframe we are sing to generate the table 

##remember to put the "" mark, it only has 2 choices one is fraction and the other one is analytical samples, each kind will generate a pre-determined table

# when kind ==  fraction meaning we are geneating plots whose rows are fractions, like the table of 0 for precursor intensity 

# when kind == analytical sample the rows will be sample names like the table for the percentage of samples under 20 in MS2 per MS2 value

percentage_table <- function(kind, n)
{
  
  B=c(5,25,50,75,95)
  
  # generate a dataframe
  num_row <-  as.numeric(count(unique(select(n, contains(kind)))))
  
  if(kind=="fraction")
  {
    perc_table = matrix(,nrow = length(fractions), ncol = length(B))
  } else 
  {
    if(kind=="analytical")
    {
      perc_table = matrix(,nrow = length(analyticalSamples), ncol = length(B))
    }
  }
  
  if(kind == "fraction"){
    for (i in 1:nrow(perc_table)){
      for (j in 1:length(B)){
        if(sum(n$Fraction == i) > 0)
        {
          perc_table[i,j]<-round(length(which(n$Percentile == B[j] & n$Fraction == i))/length(which(QCmetricsLongPrecInt_ALL$Fraction == i &QCmetricsLongPrecInt_ALL$Percentile == B[j]))*100, 
                                 3)
        }
        else
        {
          perc_table[i,j]<- 0
        }
        
      }
    }
    colnames(perc_table) <- c("5th Perc", "25th Perc", "50th Perc", "75th Perc","95th Perc")
    rownames(perc_table) <- c(paste0("fraction", 1:24))##c(1:25)))
    kable(perc_table)# %>% kable_styling(bootstrap_options = "striped", full_width = F)
    
  }else 
  {
    if(kind == "analytical"){
      for (i in 1:length(analyticalSamples)){
        for(j in 1:length(B)){
          perc_table[i,j] <- round(length(which(n$Percentile == B[j] & n$value <20 & n$analyticalBasename == analyticalSamples[i] ))/ length(which(n$Percentile == B[j] & n$analyticalBasename == analyticalSamples[i]))*100,
                                   3)
        }
      }
      colnames(perc_table) <- c(paste0(B, rep("th Perc", 5)))
      rownames(perc_table) <- c(as.character(analyticalSamples))
      kable(perc_table, caption = "Percent of samples' value less than 20") #%>%
      # kable_styling(bootstrap_options = "striped") 
    }
  }
}

#percentage_table("fraction",QCPrecIntof0_ALL )

```  


<P/>
Metrics: <a href="`r basename(QCmetrics_file)`" target="_blank"><b>`r basename(QCmetrics_file)`</b></a>

# Experimental Design

```{r echo=FALSE,results='asis'}
t <- table(QCmetrics$analyticalBasenameIndex)
mat_t <- matrix(NA, ncol=3, nrow=length(levels(QCmetrics$analyticalBasenameFactor)))
mat_t[,1] <- 1:length(levels(QCmetrics$analyticalBasenameFactor))
mat_t[,2] <- levels(QCmetrics$analyticalBasenameFactor)
mat_t[,3] <- as.matrix(t)[,1]
colnames(mat_t) <- c("Index","Analytical sample", "Fractions")
kable(mat_t) %>% kable_styling(bootstrap_options = "striped", full_width = TRUE)
```
  
<br><br>
<br><br>
<br><br>
 
# MS/MS spectra

## Total MS/MS Spectra by Analytical Sample

This graph gives the total number of MS/MS spectra per analytical sample, summed up over fractions (separate scales for all and identified MS/MS spectra). Each analytical sample is represented by a different color. 

```{r}
gg_points <- function(data, y_string, x_string,
                   col_string, label_string)
{
  ggplot(data, aes_string(y=y_string, x=x_string, 
                          col=col_string, label=label_string)) +
  geom_point() +
  theme(axis.title.x=element_blank(),
        plot.margin = margin(0.2, 1.0, 0.2, 1.0, "cm"),
        # axis.text.x=element_blank(),
        legend.position="none")
}

gg_box <- function(data, y_string, x_string,
                   col_string, label_string, label2_string="Fraction",
                   same_scale=FALSE, min_y=NULL, max_y=NULL)
{
  b <- ggplot(data, aes_string(y=y_string, x=x_string, 
                               col=col_string, label=label_string,
                               label2=label2_string)) +
    geom_boxplot()+
    geom_point(alpha=0.6) +
    theme(axis.title.x=element_blank(),
          plot.margin = margin(0.2, 1.0, 0.2, 1.0, "cm"),
          # axis.text.x=element_blank(),
          legend.position="none")
  if(same_scale)
  {
    b <- b+ylim(min_y, max_y)
  }
  b
}

gg_points_frac <- function(data, y_string, x_string,
                           col_string, label_string, label2_string="Fraction",
                           smooth=FALSE,boxplot=FALSE,                   
                           same_scale=FALSE, min_y=NULL, max_y=NULL)
{
  x_string_fact <- paste("as.factor(",x_string,")",sep="")
  x_string_used = ""
  if(boxplot)
  {
    x_string_used <- x_string_fact
  } else {
    x_string_used <- x_string
  }
  
 
  fractions.unique.orig=unique(data[,x_string])
  fractions.relevel=factor(data[,x_string], levels=ordered(fractions.unique.orig))
  data[,x_string]=fractions.relevel
  
  data.original.level=as.vector(unique(data[, x_string]))
  data[, x_string] = as.numeric(data[, x_string])
  
  
  break.points=as.numeric(unique(data[, x_string]))
  new.break.points=break.points
  if(length(break.points)>6){
    divisor=floor(length(break.points)/4)
    max.x=divisor*4
    new.break.points=break.points[seq(from=1,to=max.x, by=divisor)]
    if(new.break.points[length(new.break.points)]<max(break.points)) new.break.points=c(new.break.points, max(break.points))
  }
  

  pf <- 
 
     ggplot(data, aes_string(y=y_string, x=x_string   # x_string_used
                                , 
                                label=label_string,
                                label2=label2_string
                                ))   +   
    # scale_x_discrete(breaks=break.points, labels=break.points) +
    # scale_x_continuous(breaks=c(1,4,9), labels=c(1,4,9)) +
    scale_x_continuous(breaks = new.break.points, labels = data.original.level[new.break.points]) +
    theme(axis.title.x=element_blank(),
          axis.title.y=element_blank(), #           panel.margin.x=unit(0.5, "lines") , panel.margin.y=unit(1,"lines"), # added 4/12
          plot.margin = margin(0.2, 1.0, 0.2, 1.0, "cm"),
          legend.position="none")    
      

  if(same_scale)
  {
    pf <- pf+ylim(min_y, max_y)
  }
  if(boxplot)
  {
    pf <- pf+geom_boxplot()
  }
  if(smooth)
  {
    pf <- pf+stat_smooth(aes_string(y=y_string, x=x_string, col=col_string),
                         method="loess", fill="grey50", size=0)
  }
  pf + geom_point(aes_string(col=col_string))
}

gg_points_frac_perc <- function(data, y_string, x_string,
                                col_string, group_string,
                                label_string, label2_string="Fraction",
                                boxplot=FALSE,
                                same_scale=TRUE, min_y=NULL, max_y=NULL)
{
  

  fractions.unique.orig=unique(data[,x_string])
  fractions.relevel=factor(data[,x_string], levels=ordered(fractions.unique.orig))
  data[,x_string]=fractions.relevel
  
  data.original.level=as.vector(unique(data[, x_string]))
  data[, x_string] = as.numeric(data[, x_string])
  
  
  break.points=as.numeric(unique(data[, x_string]))
  new.break.points=break.points
  if(length(break.points)>6){
    divisor=floor(length(break.points)/4)
    max.x=divisor*4
    new.break.points=break.points[seq(from=1,to=max.x, by=divisor)]
    if(new.break.points[length(new.break.points)]<max(break.points)) new.break.points=c(new.break.points, max(break.points))
  }


  
  pfc <- 
     ggplot(data, 
                  aes_string(y=y_string, x=x_string, 
                             col=col_string, group=group_string,
                             label=label_string, label2=label2_string)) + 
        facet_grid(~ Percentile)   +
        scale_x_continuous(breaks = new.break.points, labels=data.original.level[new.break.points]) 
    
  
  if(same_scale){
    pfc <- pfc +  ylim(min_y,max_y)
  }  
  if(boxplot){
    pfc <- pfc + geom_boxplot() +
      theme(axis.title.x=element_blank(),
      #      axis.text.x=element_blank(),
            legend.position="none")
  } else {
    pfc <- pfc +
      theme(legend.position = "none")
  }
  pfc + geom_point(aes_string(col=col_string), alpha=0.6, size=0.9)
}
```


```{r,fig.height=3, fig.width=10}

# get the max and the min number of MS2 spectra, including ALL and ID
max_MS2 <- max(max(QCmetrics_AS$numofMS2_ALL_per_AS), max(QCmetrics_AS$numofMS2_ID_per_AS))
min_MS2 <- min(min(QCmetrics_AS$numofMS2_ALL_per_AS), min(QCmetrics_AS$numofMS2_ID_per_AS))

##Get plot of number of spectra
g_MS2box_all <- gg_points(QCmetrics_AS, 
                          y_string="numofMS2_ALL_per_AS", x_string="analyticalBasename",
                          col_string="analyticalBasename", label_string="`Analytical sample`")
p_MS2box_all <- ggplotly(g_MS2box_all, tooltip=c("label")) %>% layout(annotations=all_spect_title)

##Get plot of number of spectra
g_MS2box_id <- gg_points(QCmetrics_AS, 
                         y_string="numofMS2_ID_per_AS", x_string="analyticalBasename",
                         col_string="analyticalBasename", label_string="`Analytical sample`")
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label")) %>% layout(annotations=id_spect_title)

subplot(p_MS2box_all,p_MS2box_id, margin=0.05)##, titleX=TRUE, titleY=TRUE)
```

## MS/MS Spectra for Fractions by Analytical Sample

This graph represents the boxplot of the number of MS/MS spectra across fraction versus the analytical sample (separate scales for all and identified MS/MS spectra). Each analytical sample is represented by a different color. 

```{r,fig.height=3, fig.width=10}

# get the max and the min number of MS2 spectra, including ALL and ID
max_MS2 <- max(max(QCmetrics$numofMS2_ALL), max(QCmetrics$numofMS2_ID))
min_MS2 <- min(min(QCmetrics$numofMS2_ALL), min(QCmetrics$numofMS2_ID))


##Get boxplot of number of spectra across fractions
g_MS2box_all <- gg_box(QCmetrics, y_string="numofMS2_ALL", x_string="analyticalBasename",
                       col_string="analyticalBasename", label_string="`Analytical sample`")
p_MS2box_all <- ggplotly(g_MS2box_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title)

##Get boxplot of number of spectra across fractions
g_MS2box_id <- gg_box(QCmetrics, y_string="numofMS2_ID", x_string="analyticalBasename",
                      col_string="analyticalBasename", label_string="`Analytical sample`")
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title)

subplot(p_MS2box_all,p_MS2box_id, margin=0.05)##, titleX=TRUE, titleY=TRUE)

```
<br><br>

## MS/MS Spectra for Fractions by Analytical Sample (linked)

This box plot gives the number of MS/MS spectra across fraction versus the analytical sample (same scale for all and identified MS/MS spectra). Each analytical sample is represented by a different color. 

```{r,fig.height=3, fig.width=10}

##Get boxplot of number of spectra across fractions
g_MS2box_all <- gg_box(QCmetrics, y_string="numofMS2_ALL", x_string="analyticalBasename",
                       col_string="analyticalBasename", label_string="`Analytical sample`",
                       same_scale=TRUE,
                       min_y=min_MS2,
                       max_y=max_MS2)
p_MS2box_all <- ggplotly(g_MS2box_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title)

##Get boxplot of number of spectra across fractions
g_MS2box_id <- gg_box(QCmetrics, y_string="numofMS2_ID", x_string="analyticalBasename",
                      col_string="analyticalBasename", label_string="`Analytical sample`",
                      same_scale=TRUE,
                      min_y=min_MS2,
                      max_y=max_MS2)
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title)

subplot(p_MS2box_all, p_MS2box_id, margin=0.05)
```
<br><br>

## MS/MS Spectra for Analytical Samples by Fraction

This graph shows the scatter plot of the number of MS/MS spectra versus the fraction (separate scales for all and identified MS/MS spectra). Each analytical sample is represented by a different color. The grey area represents the 95% confidence interval for each analytical sample when fitting the default smooth curves. 

```{r, fig.height=3, fig.width=10}
g_MS2sca_all <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ALL", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               smooth=TRUE)
p_MS2sca_all <- ggplotly(g_MS2sca_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title)

g_MS2sca_id <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ID", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               smooth=TRUE)
p_MS2sca_id <- ggplotly(g_MS2sca_id, tooltip=c("label","label2"))  %>% layout(annotations=id_spect_title)

subplot(p_MS2sca_all, p_MS2sca_id, margin=0.05)


```

<br><br>

## MS/MS Spectra for Analytical Samples by Fraction (linked)

This graph shows the scatter plot of the number of MS/MS spectra versus fractions (same scale for all and identified MS/MS spectra). Each analytical sample is represented by a different color. The grey area represent the 95% confidence interval for each analytical sample when fitting the default smooth curves.

```{r,fig.width=10, fig.height=3}
g_MS2sca_all <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ALL", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               smooth=TRUE,
                               same_scale = TRUE, 
                               min_y=min_MS2,
                               max_y=max_MS2)
p_MS2sca_all <- ggplotly(g_MS2sca_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title)

g_MS2sca_id <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ID", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               smooth=TRUE,
                               same_scale = TRUE, 
                               min_y=min_MS2,
                               max_y=max_MS2)
p_MS2sca_id <- ggplotly(g_MS2sca_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title)

subplot(p_MS2sca_all, p_MS2sca_id, margin=0.05)

```


<br><br>

## MS/MS Spectra for Analytical Samples by Fraction (box plot)

This box plot shows the number of MS/MS spectra versus the fraction (separate scales for all and identified MS/MS spectra). Each analytical sample is represented by a different color. The grey area represent the 95% confidence interval for each analytical sample when fitting the default smooth curves.

```{r,  fig.width=10, fig.height=3}
g_MS2box2_all <- gg_points_frac(QCmetrics,
                                y_string="numofMS2_ALL", x_string="Fraction",
                                col_string="analyticalBasename",
                                label_string = "`Analytical sample`",
                                smooth=TRUE, boxplot=TRUE)
p_MS2box2_all <- ggplotly(g_MS2box2_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title)

g_MS2box2_id <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ID", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               smooth=TRUE, boxplot=TRUE)
p_MS2box2_id <- ggplotly(g_MS2box2_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title)

subplot(p_MS2box2_all, p_MS2box2_id, margin=0.05)

```

<br><br>



  
## MS/MS Spectra for Analytical Samples by Fraction (box plot, linked)

This boxplot shows the number of MS/MS spectra versus the fraction (same scale for all and identified MS/MS spectra). Each analytical sample is represented by a different color. The grey area represent the 95% confidence interval for each analytical sample when fitting the default smooth curves.

```{r,  fig.width=10, fig.height=3}
g_MS2box2_all <- gg_points_frac(QCmetrics,
                                y_string="numofMS2_ALL", x_string="Fraction",
                                col_string="analyticalBasename",
                                label_string = "`Analytical sample`",
                                smooth=TRUE, boxplot=TRUE,
                                same_scale = TRUE, 
                                min_y=min_MS2,
                                max_y=max_MS2)
p_MS2box2_all <- ggplotly(g_MS2box2_all, tooltip=c("label","label2"))

g_MS2box2_id <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ID", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               smooth=TRUE, boxplot = TRUE,
                               same_scale = TRUE, 
                               min_y=min_MS2,
                               max_y=max_MS2)
p_MS2box2_id <- ggplotly(g_MS2box2_id, tooltip=c("label","label2")) 

subplot(p_MS2box2_all, p_MS2box2_id, margin=0.05)



```
<br><br>
<br><br>
<br><br>

 
  
# Precursor Intensity
<!--
## Range of precursor intensity values for all MS/MS spectra
  This table shows the range of the precursor intensity for each percentile, as a summary.
  Note that values of 0 cannot be log-transformed.

```{r, results='hide'}
B = c(5,25,50,75,95)

rangetable_ALL = matrix(,nrow = 2, ncol = length(B), byrow = TRUE)
for (i in 1:length(B)){
  rangesub_ALL <-subset(QCmetricsLongPrecInt_ALL, QCmetricsLongPrecInt_ALL$Percentile == B[i])
  
  # filter to get only the wanted percentile
  #print(range(rangesub$value))
  rangetable_ALL[1,i] <- toString(round(range(rangesub_ALL$value),2))
  rangetable_ALL[2,i] <- toString(signif(log10(range(rangesub_ALL$value)),3))
}
colnames(rangetable_ALL)<-c("5th Perc","25th perc","50th perc","75th perc","95th perc")
rownames(rangetable_ALL)<-c("range", "range of log10 transformed")
kable(rangetable_ALL)# %>% kable_styling(bootstrap_options = "striped", full_width = FALSE)

```
<br><br>

  
## Range of precursor intensity values for identified MS/MS spectra
  This table shows the range of the precursor intensity for each percentile, as a summary. Note that values of 0 cannot be log-transformed.
  
```{r}
B = c(5,25,50,75,95)

rangetable_ID = matrix(,nrow = 2, ncol = length(B), byrow = TRUE)
for (i in 1:length(B)){
  rangesub_ID <-subset(QCmetricsLongPrecInt_ID, QCmetricsLongPrecInt_ID$Percentile == B[i])
  
  # filter to get only the wanted percentile
  #print(range(rangesub$value))
  rangetable_ID[1,i] <- toString(round(range(rangesub_ID$value),2))
  rangetable_ID[2,i] <- toString(signif(log10(range(rangesub_ID$value)),3))
}
colnames(rangetable_ID)<-c("5th Perc","25th perc","50th perc","75th perc","95th perc")
rownames(rangetable_ID)<-c("range", "range of log10 transformed")
kable(rangetable_ID)# %>% kable_styling(bootstrap_options = "striped", full_width = FALSE)

```

<br><br>



-->



## Precursor Intensity Percentiles for Analytical Samples by Fraction

This graph shows scatter plots of the 5%,25%,50%,75%,95% for log10(precursor intensity) values versus fractions (same scale for all and identified MS/MS spectra). Each panel is a different percentile. Each analytical sample is represented by a different color. 

```{r, fig.width=10, fig.height=3}
# get the smallest and the largest value for all and identified seperately to help set the axis range
# Important! Shaojun add 0.5 value to the min and max value to advoid not ploting the points correctly

Pmin_ALL <- log10(min(QCmetricsLongPrecInt_ALL$value[QCmetricsLongPrecInt_ALL$value > 0])) - 0.5
Pmax_ALL <- log10(max(subset(QCmetricsLongPrecInt_ALL, Percentile <= 95,select=c(value)))) + 0.5
Pmin_ID <- log10(min(QCmetricsLongPrecInt_ID$value[QCmetricsLongPrecInt_ID$value > 0]))    - 0.5
Pmax_ID <- log10(max(subset(QCmetricsLongPrecInt_ID, Percentile <= 95,select=c(value))))   + 0.5


QCmetricsLongPrecInt_ALL$value2 <- QCmetricsLongPrecInt_ALL$value
QCmetricsLongPrecInt_ALL$value2[QCmetricsLongPrecInt_ALL$value2 == 0] <-
  min(QCmetricsLongPrecInt_ALL$value2[QCmetricsLongPrecInt_ALL$value2 > 0])*0.5

g_PIsca_all <- gg_points_frac_perc(filter(QCmetricsLongPrecInt_ALL, Percentile %in% c(5,25,50,75,95)),
                                   y_string = "log10(value2)",
                                   x_string = "Fraction",
                                   col_string = "analyticalBasename",
                                   group_string="analyticalBasename",
                                   label_string="`Analytical sample`",
                                   min_y=min(Pmin_ALL,Pmin_ID),
                                   max_y=max(Pmax_ALL, Pmax_ID))
  
p_PIsca_all <- ggplotly(g_PIsca_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid)

QCmetricsLongPrecInt_ID$value2 <- QCmetricsLongPrecInt_ID$value
QCmetricsLongPrecInt_ID$value2[QCmetricsLongPrecInt_ID$value2 == 0] <-
  min(QCmetricsLongPrecInt_ID$value2[QCmetricsLongPrecInt_ID$value2 > 0])*0.5

#CAUTION!!!!In this case we've rename the column and may change the result
#colnames(QCmetricsLongMS2Charge_ID)[6] <- "value"

# Or, we might not need to change the variable name
g_PIsca_id <- gg_points_frac_perc(filter(QCmetricsLongPrecInt_ID, Percentile %in% c(5,25,50,75,95)),
                                  y_string = "log10(value2)",
                                  x_string = "Fraction",
                                  col_string = "analyticalBasename",
                                  group_string="analyticalBasename",
                                  label_string="`Analytical sample`",
                                  min_y=min(Pmin_ALL,Pmin_ID),
                                  max_y=max(Pmax_ALL, Pmax_ID))
p_PIsca_id <- ggplotly(g_PIsca_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid)

subplot(p_PIsca_all, p_PIsca_id, titleY=TRUE)


```



  
<br><br>
<br><br>
<br><br>

  
    
# Precursor m/z 


## Precursor m/z Percentiles for Analytical Samplesby Fraction

This graph shows the scatter plot of the 5%,25%,50%,75%,95% for precursor m/z values versus fractions (same scale for all and identified MS/MS spectra). Each panel is a different percentile. Each analytical sample is represented by a different color. 

```{r,fig.width=10, fig.height=3}
g_all <- gg_points_frac_perc(filter(QCmetricsLongPrecMZ_ALL, Percentile %in% c(5,25,50,75,95)),
                             y_string = "value",
                             x_string = "Fraction",
                             col_string = "analyticalBasename",
                             group_string="analyticalBasename",
                             label_string="`Analytical sample`",
                             min_y=find_min(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID),
                             max_y=find_max(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID))
p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid)

g_id <- gg_points_frac_perc(filter(QCmetricsLongPrecMZ_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID),
                            max_y=find_max(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID))
p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid)

subplot(p_all, p_id, margin=0.05)
```

<br><br>



    
# Precursor Molecular Weight 

## Precursor Molecular Weight Percentiles for Analytical Samples by Fraction


This graph shows the scatter plot of the 5%,25%,50%,75%,95% for precursor molecular weight values versus fractions (same scale for all and identified MS/MS spectra). Each panel is a different percentile. Each analytical sample is represented by a different color. 

```{r,fig.width=10, fig.height=3}
g_all <- gg_points_frac_perc(filter(QCmetricsLongPrecMW_ALL, Percentile %in% c(5,25,50,75,95)),
                             y_string = "value",
                             x_string = "Fraction",
                             col_string = "analyticalBasename",
                             group_string="analyticalBasename",
                             label_string="`Analytical sample`",
                             min_y=find_min(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID),
                             max_y=find_max(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID))
p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid)

g_id <- gg_points_frac_perc(filter(QCmetricsLongPrecMW_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID),
                            max_y=find_max(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID))
p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid)

subplot(p_all, p_id, margin=0.05)

```

<br><br>




<!--

## Precursor molecular weight for each analytical sample & fraction combination: [ by sample ]  [ box plot ]  [ same scale ]

This boxplot shows the 5%,25%,50%,75%,95% for precursor molecular weight values across fractions (same scale for all and identified MS/MS spectra). Each panel is a different percentile. Each analytical sample is represented by a different color. 

```{r,fig.width=10, fig.height=3}
g_all <- gg_points_frac_perc(filter(QCmetricsLongPrecMW_ALL, Percentile %in% c(5,25,50,75,95)),
                             y_string = "value",
                             x_string = "analyticalBasename",   #  "Fraction", # 
                             col_string = "analyticalBasename",
                             group_string="analyticalBasename",
                             label_string="`Analytical sample`",
                             boxplot=TRUE,
                             min_y=find_min(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID),
                             max_y=find_max(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID))
p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid)

g_id <- gg_points_frac_perc(filter(QCmetricsLongPrecMW_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "analyticalBasename", # "Fraction",  change from analyticalBasename to Fraction
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            boxplot=TRUE,
                            min_y=find_min(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID),
                            max_y=find_max(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID))
p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid)

subplot(p_all, p_id, margin=0.05)

```
<br><br>
<br><br>
<br><br>

-->

    
# MS/MS Spectra per Cycle

## MS/MS Spectra per Cycle for Analytical Samples by Fraction

This graph shows the scatterplot of the 5%,25%,50%,75%,95% for MS/MS per MS1 values versus fractions (same scale for all and identified MS/MS spectra). Each panel is a different percentile. Each analytical sample is represented by a different color. Note: the missing points in 5% are due to missing (zero) precursor intensity values in the mzML file

```{r,fig.width=10, fig.height=3}
g_all <- gg_points_frac_perc(filter(QCmetricsLongMS2perMS_ALL, Percentile %in% c(5,25,50,75,95)),
                             y_string = "value",
                             x_string = "Fraction",
                             col_string = "analyticalBasename",
                             group_string="analyticalBasename",
                             label_string="`Analytical sample`",
                             min_y=find_min(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID),
                             max_y=find_max(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID))
p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid)

g_id <- gg_points_frac_perc(filter(QCmetricsLongMS2perMS_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID),
                            max_y=find_max(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID))
p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid)

subplot(p_all, p_id, margin=0.05)

min.ms2perms1=find_min(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID)
# if(min.ms2perms1==0){cat("The missing points in are due to missing (zero) precursor intensity values in the mzML file")}

```

<br><br>



<!--

## Median of MS/MS per MS1 value for all MS/MS spectra
This table presents the median MS/MS per MS1 value for each percentile (each column represents a different percentile and each row a different analytical sample). 

```{r}

## generate a table which will show the median of the value for each percentile

find_median_table <-function(n){
  
  # Use B to define the different percentile we want in the table 
  B = c(5,25,50,75,95)
  
  # generate the data frame we want to show in the table 
  dataframetable = matrix(, nrow = length(analyticalSamples), ncol = length(B)) 
  for (i in 1: length(analyticalSamples)){
    for (j in 1:length(B)){ 
      D <-subset(n , Percentile == B[j] & analyticalBasename == analyticalSamples[i],select=c(value))
      dataframetable[i,j] <- median(D$value)
    }
    }
  #QCPrecIntTable_ALL
  colnames(dataframetable) <- c(paste0(B, rep("th Perc", 5)))
  rownames(dataframetable) <- c(as.character(analyticalSamples))
  kable(dataframetable, caption = "The median of MS/MS per MS1")# %>%
 # kable_styling(bootstrap_options = "striped") 
  
}


find_median_table(QCmetricsLongMS2perMS_ALL)

```

<br><br>



## Median of MS/MS per MS1 value for identified MS/MS spectra
This table presents the median MS/MS per MS1 value for each percentile (each column represents a different percentile and each row a different analytical sample). 

```{r}

find_median_table(QCmetricsLongMS2perMS_ID)

```

<br><br>
<br><br>
<br><br>

-->

  
# Precursor Charge state
  
## Overall Precursor Charge State Distribution

This graph shows the proportions of charge states for MS/MS spectra (same scale for all and identified MS/MS spectra). Each charge state is represented by a different color.

```{r,  fig.width=10, fig.height=3}

min_ratio <- min(chargestateratio_ALL, chargestateratio_ID)
max_ratio <- max(chargestateratio_ALL, chargestateratio_ID)

g_chargeratio_all <- ggplot(Chargeratio_ALL, aes(x=chargestate, y=chargestateratio_ALL)) +
  geom_bar(stat="identity", aes(fill = chargestate)) +
  geom_text(aes(label = round(chargestateratio_ALL,3)), vjust=-0.3, size=4) +
  scale_color_manual (values = c(plotcolor), name = "Analytical Sample") +
  scale_fill_discrete(name = "Charge State") +
  #stat_smooth(method="loess", fill="grey50", size=0)+
  ggtitle(title_ALL) +
  xlab("MS2 charge state") + ylab("Proportion") +
  ylim(min_ratio, max_ratio*1.05) +
  theme(axis.text.x= element_text(angle = 0)) +
  theme(legend.position="none",
        plot.title = element_text(hjust=0.5))

g_chargeratio_ID <- ggplot(Chargeratio_ID, aes(y=chargestateratio_ID, x=chargestate)) +
  geom_bar(stat="identity",aes(fill = chargestate)) +
  geom_text(aes(label = round(chargestateratio_ID,3)), vjust=-0.3, size=4) +
  scale_color_manual (values = c(plotcolor), name = "Analytical Sample") +
  #stat_smooth(method="loess", fill="grey50", size=0)+
  scale_fill_discrete(name = "Charge State") +
  ggtitle(title_ID) +
  xlab("MS2 charge state") + ylab("Proportion") +
  ylim(min_ratio, max_ratio*1.05) +
  theme(axis.text.x= element_text(angle = 0)) +
  theme(legend.position="none",
        plot.title = element_text(hjust=0.5))


grid_arrange_shared_legend(g_chargeratio_all, g_chargeratio_ID, ncol=2)



```

<br><br>

# Peptides 

## MS/MS Distinct Peptides for Fractions by Analytical Sample
```{r,fig.height=3, fig.width=10}
#(Jiahao)
##get total number of spectra per analytical sample
numofPeptide_ID_per_AS <- tapply(QCmetrics$PeptideCount, INDEX=QCmetrics$analyticalBasename, FUN=sum)
# identical(names(numofPeptide_ALL_per_AS), names(numofPeptide_ID_per_AS))

QCmetrics_AS <- data.frame(analyticalBasename=names(numofPeptide_ID_per_AS),
                           numofPeptide_ID_per_AS=numofPeptide_ID_per_AS)
QCmetrics_AS$`Analytical sample` <- QCmetrics_AS$analyticalBasename

```

This graph represents the boxplot of the number of MS/MS spectra across fraction versus the analytical sample (separate scales for all and identified MS/MS spectra). Each analytical sample is represented by a different color. 

```{r,fig.height=3, fig.width=10}

# get the max and the min number of MS2 peptide counts, including ALL and ID
max_MS2 <- max(QCmetrics$PeptideCount)
min_MS2 <- min(QCmetrics$PeptideCount)


##Get boxplot of number of peptide counts across fractions
g_MS2box_id <- gg_box(QCmetrics, y_string="PeptideCount", x_string="analyticalBasename",
                      col_string="analyticalBasename", label_string="`Analytical sample`")
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=peptide_title)

subplot(p_MS2box_id, margin=0.05) ##, titleX=TRUE, titleY=TRUE)

```
<br><br>

## MS/MS Peptides Redundancy Plot for Fractions by Analytical Sample

This graph shows the scatter plot of the 5%,25%,50%,75%,95% for Peptides Redundancy values versus fractions (same scale for all and identified MS/MS spectra). Each panel is a different percentile. Each analytical sample is represented by a different color. 

```{r,fig.width=10, fig.height=3}
g_id <- gg_points_frac_perc(filter(QCmetricsPeptideRd, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            #min_y=find_min(QCmetricsPeptideRd),
                            min_y = min(subset(QCmetricsPeptideRd, Percentile <= 95,select=c(value))),
                            #max_y=find_max(QCmetricsPeptideRd))
                            max_y = max(subset(QCmetricsPeptideRd, Percentile <= 95,select=c(value))))

p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=peptide_rd)

subplot(p_id, margin=0.05)

```
<br><br>


# Retention Time


## MS/MS Spectra Retention Time Plot for Fractions by Analytical Sample

This graph shows the scatter plot of the 5%,25%,50%,75%,95% for spectra retention time versus fractions (same scale for all and identified MS/MS spectra). Each panel is a different percentile. Each analytical sample is represented by a different color. 

```{r,fig.width=10, fig.height=3}
g_all <- gg_points_frac_perc(filter(QCmetricsPeptideRT_ALL, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID),
                            #min_y = min(subset(QCmetricsPeptideRT_ALL, Percentile <= 95,select=c(value))),
                            max_y=find_max(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID))
                            #max_y = max(subset(QCmetricsPeptideRT_ALL, Percentile <= 95,select=c(value))))

p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_retention)

g_id <- gg_points_frac_perc(filter(QCmetricsPeptideRT_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID),
                            #min_y = min(subset(QCmetricsPeptideRT_ID, Percentile <= 95,select=c(value))),
                            max_y=find_max(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID))
                            #max_y = max(subset(QCmetricsPeptideRT_ID, Percentile <= 95,select=c(value))))

p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_retention)

subplot(p_all, p_id, margin=0.05)

```


  
